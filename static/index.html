<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>8BIT Upbit Bot UI</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    html, body{ overflow-anchor: none; }
    body{background:#0b1220;color:#ffffff;font-family:-apple-system, Segoe UI, Roboto, 'Noto Sans KR', Arial, sans-serif;font-size:14px}
    .card{background:#1e2329;border:1px solid rgba(255,255,255,0.08)}
    #tvChart{width:80%;height:82vh;min-height:460px}
    .kv{display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px dashed rgba(255,255,255,0.08)}
    .buy{color:#0ecb81}.sell{color:#f6465d}
    @media (max-width: 991px){ #tvChart{height:70vh} }
    .toolbar .form-control,.toolbar .form-select{color:#ffffff;background:#2b3139;border:1px solid rgba(255,255,255,0.2)}
    .toolbar .btn{color:#ffffff}
    .form-check-label{color:#e0e7ff}
    .kv span:first-child{color:#ffffff}
    .kv span:last-child{color:#ffffff;font-weight:700}
    .badge{color:#ffffff}
    .text-muted{color:#ffffff !important}
    /* Assets UI */
    .asset-stat{background:#0e1424;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px}
    .asset-stat .label{color:#ffffff;font-size:12px}
    .asset-stat .value{color:#ffffff;font-size:20px;font-weight:700}
    .asset-bars{display:flex;flex-direction:column;gap:8px}
    .asset-bar .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .asset-bar .label{color:#ffffff;font-weight:600}
    .asset-bar .muted{color:#ffffff;font-size:12px;margin-left:8px}
    .asset-bar .meter{height:10px;border-radius:6px;background:#10182a;overflow:hidden;border:1px solid rgba(255,255,255,0.08)}
    .asset-bar .fill{height:100%;background:linear-gradient(90deg,#0ecb81,#2bdab5)}
    .asset-bar.krw .fill{background:linear-gradient(90deg,#4285f4,#72a6ff)}
    .chip{display:inline-block;padding:3px 8px;margin:2px;border-radius:999px;background:#2b3139;border:1px solid rgba(255,255,255,0.12);font-size:12px;color:#ffffff}
    .chip-selected{background:#0ecb81;color:#0b1220;border-color:#0ecb81;font-weight:700}
    .chip-muted{background:#2b3139;color:#9ba4b5;border-color:rgba(255,255,255,0.08);opacity:0.65}
    /* Win list */
    #winList{display:flex;flex-direction:column;gap:6px;overflow-y:auto;overflow-x:hidden}
    #winList{scrollbar-width:none;-ms-overflow-style:none}
    #winList::-webkit-scrollbar{width:0;height:0}
    /* Win card scroll hide scrollbar */
    #winCard{scrollbar-width:none;-ms-overflow-style:none}
    #winCard::-webkit-scrollbar{width:0;height:0}
    .win-chip{display:flex;flex-direction:column;align-items:flex-start;gap:4px;text-align:left;border:1px solid rgba(255,255,255,0.15);border-radius:8px;padding:6px 10px;color:#ffffff;background:#1b2437;transition:transform .2s ease, box-shadow .2s ease;min-height:auto}
    .win-chip.positive{background:linear-gradient(90deg,rgba(14,203,129,0.35),rgba(14,203,129,0.10));}
    .win-chip.negative{background:linear-gradient(90deg,rgba(246,70,93,0.35),rgba(246,70,93,0.10));}
    .win-chip:hover{transform:translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,0.35)}
    .win-chip .meta{font-size:11px;color:#d9e2f3;line-height:1.3;text-align:left}
    .win-chip .val{font-weight:700;white-space:normal;word-break:break-word;flex:1}
    /* Zone badge on win buttons */
    .zone-badge{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;font-weight:700;color:#0b1220}
    .zone-blue{background:#00d1ff;color:#0b1220}
    .zone-orange{background:#ffb703;color:#0b1220}
    
    /* Zone display improvements */
    .zone-display-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .zone-display-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    
    .zone-display-label {
      font-size: 10px;
      color: #888888;
      font-weight: 500;
    }
    
    .zone-display-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .zone-divider {
      width: 1px;
      height: 20px;
      background: rgba(255,255,255,0.2);
    }
    
    .zone-stats {
      font-size: 11px;
      color: #ffffff;
      font-weight: 500;
    }
    
    /* ë¶„ë´‰ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    .timeframe-cards-container {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 5px 0;
    }
    
    .timeframe-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      min-width: 80px;
      background: rgba(52, 73, 94, 0.8);
      border: 1px solid #34495e;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .timeframe-card:hover {
      background: rgba(52, 152, 219, 0.3);
      border-color: #3498db;
      transform: translateY(-2px);
    }
    
    .timeframe-card.active {
      background: rgba(52, 152, 219, 0.5);
      border-color: #3498db;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
    }
    
    .timeframe-icon {
      font-size: 20px;
      margin-bottom: 5px;
    }
    
    .timeframe-name {
      font-weight: bold;
      color: #ecf0f1;
      font-size: 14px;
      margin-bottom: 3px;
    }
    
    .timeframe-status {
      font-size: 10px;
      color: #2ecc71;
      font-weight: 500;
    }
    
         .timeframe-card:not(.active) .timeframe-status {
       color: #95a5a6;
     }
     
           /* í•˜ë‹¨ ë¶„ë´‰ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
      .timeframe-cards-container-bottom {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding: 5px 0;
        justify-content: center;
        min-height: 80px;
      }
      
      .timeframe-card-bottom {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
        min-width: 70px;
        background: rgba(52, 73, 94, 0.8);
        border: 1px solid #34495e;
        border-radius: 6px;
        transition: all 0.3s ease;
        cursor: pointer;
        flex-shrink: 0;
        height: 60px;
        justify-content: center;
      }
      
      .timeframe-card-bottom:hover {
        background: rgba(52, 152, 219, 0.3);
        border-color: #3498db;
        transform: translateY(-2px);
      }
      
      .timeframe-card-bottom.active {
        background: rgba(52, 152, 219, 0.5);
        border-color: #3498db;
        box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
      }
      
      .timeframe-icon-bottom {
        font-size: 16px;
        margin-bottom: 3px;
        color: #ecf0f1;
      }
      
      .timeframe-name-bottom {
        font-weight: bold;
        color: #ecf0f1;
        font-size: 12px;
        margin-bottom: 2px;
      }
      
      .timeframe-status-bottom {
        font-size: 9px;
        color: #2ecc71;
        font-weight: 500;
      }
      
      .timeframe-card-bottom:not(.active) .timeframe-status-bottom {
        color: #95a5a6;
      }
    /* Win card zone theming */
    .win-card-blue{background:linear-gradient(180deg,rgba(0,209,255,0.12),rgba(0,209,255,0.04)) !important}
    .win-card-orange{background:linear-gradient(180deg,rgba(255,183,3,0.12),rgba(255,183,3,0.04)) !important}
    
    /* Win Card Styles */
    #winCard {
      overflow-y: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      max-height: 1140px;
    }
    #winCard::-webkit-scrollbar { display: none; }
    
    .win-zone-section {
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 8px;
    }
    
    .zone-consistency-display {
      font-size: 10px;
      color: #888;
    }
    
    .zone-consistency-content {
      font-size: 11px;
      color: #333;
      font-weight: 500;
      line-height: 1.2;
      padding: 4px 8px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 3px solid #0ecb81;
    }
    
    .zone-consistency-content .sync-status {
      color: #0ecb81;
      font-weight: 600;
    }
    
    .win-progress-track {
      height: 6px;
      background: #0e1424;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 6px;
      overflow: hidden;
    }
    
    .win-progress-bar {
      height: 100%;
      width: 1%;
      background: #ffffff;
      transition: width 0.4s ease;
    }
    
    .win-history-list {
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    /* PnL slider glow */
    @keyframes glowGreen { 0%{ box-shadow:0 0 0 rgba(14,203,129,0);} 50%{ box-shadow:0 0 12px rgba(14,203,129,0.8);} 100%{ box-shadow:0 0 0 rgba(14,203,129,0);} }
    @keyframes glowRed { 0%{ box-shadow:0 0 0 rgba(246,70,93,0);} 50%{ box-shadow:0 0 12px rgba(246,70,93,0.8);} 100%{ box-shadow:0 0 0 rgba(246,70,93,0);} }
    .glow-green{ animation: glowGreen .9s ease; }
    .glow-red{ animation: glowRed .9s ease; }
    #pnlLeftLabel,#pnlRightLabel{ color:#ffffff }
    /* Masonry cards animation */
    .nb-coin-item{ transition: transform .3s ease, width .3s ease, height .3s ease, opacity .3s ease; will-change: transform; }
    /* Speech bubble */
    .nb-bubble{ position:relative; background:#1b2437; border:1px solid rgba(255,255,255,0.15); border-radius:12px; padding:8px 10px; color:#ffffff; font-size:12px }
    .nb-bubble:after{ content:""; position:absolute; bottom:-6px; left:18px; border-width:6px 6px 0 6px; border-style:solid; border-color:rgba(255,255,255,0.15) transparent transparent transparent }
    .nb-bubble:before{ content:""; position:absolute; bottom:-5px; left:19px; border-width:5px 5px 0 5px; border-style:solid; border-color:#1b2437 transparent transparent transparent }
    
    /* Auto Trading Status Styles */
    .auto-trading-status {
      background: #0e1424;
      border-radius: 8px;
      padding: 12px;
    }
    
    .auto-trading-status h4 {
      color: #ffffff;
      font-size: 14px;
      margin-bottom: 12px;
      font-weight: 600;
    }
    
    .member-auto-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      font-size: 12px;
    }
    
    .member-auto-status:last-child {
      border-bottom: none;
    }
    
    .member-auto-status span {
      color: #ffffff;
    }
    
    .member-auto-status span:first-child {
      font-weight: 600;
      flex: 1;
    }
    
    .member-auto-status span:nth-child(2) {
      margin: 0 12px;
      font-size: 11px;
    }
    
    .member-auto-status span:last-child {
      font-size: 11px;
      color: #d9e2f3;
    }
    
    /* ìë™í™” ëª¨ë“œ í‘œì‹œ (ì„ íƒì ) */
    .auto-mode-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(14, 203, 129, 0.2);
      border: 1px solid #0ecb81;
      border-radius: 8px;
      padding: 8px 16px;
      color: #0ecb81;
      font-size: 12px;
      font-weight: 600;
      z-index: 10000;
      backdrop-filter: blur(10px);
      display: none; /* í•„ìš”ì‹œ í‘œì‹œ */
    }
    
    /* ë¶„ë´‰ ìˆœíšŒ í”„ë¡œê·¸ë ˆìŠ¤ë°” ìŠ¤íƒ€ì¼ */
    #timeframeCycleProgress {
      box-shadow: 0 0 10px rgba(0, 209, 255, 0.3);
      animation: progressGlow 2s ease-in-out infinite;
    }
    
    @keyframes progressGlow {
      0%, 100% { box-shadow: 0 0 10px rgba(0, 209, 255, 0.3); }
      50% { box-shadow: 0 0 20px rgba(0, 209, 255, 0.6); }
    }
    
    #timeframeCycleProgress[style*="width: 100%"] {
      animation: progressComplete 0.5s ease-in-out;
    }
    
    @keyframes progressComplete {
      0% { background: linear-gradient(90deg, #00d1ff, #4285f4); }
      50% { background: linear-gradient(90deg, #0ecb81, #2bdab5); }
      100% { background: linear-gradient(90deg, #00d1ff, #4285f4); }
    }
  </style>
</head>
<body class="text-white">
  <div class="container-fluid py-3">

    
    <div class="row g-3 justify-content-center">
      <div class="col-12 mt-3">
        <!-- ë¶„ë´‰ ì„ íƒ ì¹´ë“œ (ê¸°ì¡´ í•˜ë‹¨ ì¹´ë“œ ì´ë™) -->
        <div class="card border-secondary rounded-3 p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <strong class="text-white">ë¶„ë´‰ ì„ íƒ</strong>
            <div class="d-flex align-items-center gap-2">
              <button id="btnAutoRotateBottom" class="btn btn-sm btn-outline-info">ìë™ ìˆœíšŒ</button>
              <span id="currentTimeframeBottom" class="badge bg-primary">10m</span>
            </div>
          </div>
          <div class="timeframe-cards-container-bottom">
            <div class="timeframe-card-bottom" data-timeframe="minute1">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">1m</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="minute3">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">3m</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="minute5">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">5m</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom active" data-timeframe="minute10">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">10m</div>
              <div class="timeframe-status-bottom">í™œì„±</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="minute15">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">15m</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="minute30">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">30m</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="minute60">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">1h</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
            <div class="timeframe-card-bottom" data-timeframe="day">
              <div class="timeframe-icon-bottom">â±ï¸</div>
              <div class="timeframe-name-bottom">1D</div>
              <div class="timeframe-status-bottom">ëŒ€ê¸°</div>
            </div>
          </div>
        </div>

    <!-- Global Profit/Loss slider (uses Win% from backtest) -->
    <div class="card border-secondary rounded-3 p-2 mb-3">
      <div class="pnl-track" style="height:14px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:10px; overflow:hidden; position:relative">
        <div id="pnlCenter" style="position:absolute; left:50%; top:0; width:2px; height:100%; background:#ffffff"></div>
        <div id="pnlLeftBar" style="position:absolute; right:50%; top:0; height:100%; width:0%; background:linear-gradient(90deg, rgba(14,203,129,0.9), rgba(14,203,129,0.45)); transition:width .6s ease"></div>
        <div id="pnlRightBar" style="position:absolute; left:50%; top:0; height:100%; width:0%; background:linear-gradient(90deg, rgba(246,70,93,0.45), rgba(246,70,93,0.9)); transition:width .6s ease"></div>
      </div>
      <div class="d-flex justify-content-between mt-1" style="font-size:12px">
        <div id="pnlLeftLabel">Profit 0%</div>
        <div id="pnlRightLabel">Loss 100%</div>
      </div>
      <div class="mt-2">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <span class="text-muted" style="font-size:12px">AutoTrade Readiness</span>
          <span id="autoGaugeText" class="badge bg-secondary">-</span>
        </div>
        <div style="height:8px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:6px; overflow:hidden;">
          <div id="autoGaugeBar" style="height:100%; width:0%; background:linear-gradient(90deg,#2bdab5,#0ecb81); transition:width .4s ease"></div>
        </div>
      </div>
      
      <!-- Information Trust Sliders -->
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span class="text-muted" style="font-size:12px">Information Trust Level</span>
          <span id="trustStatusText" class="badge bg-info">Balanced</span>
        </div>
        
        <!-- ML Model Trust Slider -->
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted" style="font-size:11px">ğŸ¤– ML Model Trust</span>
            <span id="mlTrustValue" class="badge bg-primary" style="font-size:10px">50%</span>
          </div>
          <div style="height:6px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:4px; overflow:hidden; position:relative;">
            <div id="mlTrustBar" style="height:100%; width:50%; background:linear-gradient(90deg,#4285f4,#72a6ff); transition:width .3s ease"></div>
            <input type="range" id="mlTrustSlider" min="0" max="100" value="50" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
          </div>
        </div>
        
        <!-- N/B Guild Trust Slider -->
        <div class="mb-2">
          <div class="d-flex justify-content-between align-items-center mb-1">
            <span class="text-muted" style="font-size:11px">ğŸ›ï¸ N/B Guild Trust</span>
            <span id="nbTrustValue" class="badge bg-warning" style="font-size:10px">50%</span>
          </div>
          <div style="height:6px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:4px; overflow:hidden; position:relative;">
            <div id="nbTrustBar" style="height:100%; width:50%; background:linear-gradient(90deg,#ffb703,#ffd54f); transition:width .3s ease"></div>
            <input type="range" id="nbTrustSlider" min="0" max="100" value="50" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;">
          </div>
        </div>
        
        <!-- Trust Balance Indicator -->
        <div class="mt-2">
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted" style="font-size:10px">Trust Balance</span>
            <span id="trustBalanceText" class="text-muted" style="font-size:10px">ML: 50% | N/B: 50%</span>
          </div>
        </div>
      </div>
      
      <!-- ë¶„ë´‰ ìˆœíšŒ í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted" style="font-size:12px">ë¶„ë´‰ ìë™ ìˆœíšŒ</span>
            <span id="timeframeCycleStatus" class="badge bg-success" style="font-size:10px">í™œì„±</span>
          </div>
          <div class="d-flex align-items-center gap-2">
            <span id="currentTimeframeDisplay" class="badge bg-primary" style="font-size:11px">10m</span>
            <span id="nextTimeframeDisplay" class="text-muted" style="font-size:11px">â†’ 15m</span>
          </div>
        </div>
        <div style="height:16px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:8px; overflow:hidden; position:relative">
          <div id="timeframeCycleProgress" style="height:100%; width:0%; background:linear-gradient(90deg, #00d1ff, #4285f4); transition:width 0.1s linear; position:relative">
            <div style="position:absolute; right:0; top:0; bottom:0; width:2px; background:#ffffff; opacity:0.5"></div>
          </div>
          <div id="timeframeCycleText" style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); font-size:11px; font-weight:600; color:#ffffff; text-shadow:0 0 4px rgba(0,0,0,0.8); pointer-events:none">
            <span id="timeframeCyclePercent">0%</span>
          </div>
        </div>
        <div class="d-flex justify-content-between mt-1" style="font-size:10px">
          <span class="text-muted">ìˆœíšŒ ì‹œê°„: <span id="timeframeCycleDuration">30</span>ì´ˆ</span>
          <button id="toggleTimeframeCycle" class="btn btn-sm btn-outline-secondary" style="padding:2px 8px; font-size:10px">ì¼ì‹œì •ì§€</button>
        </div>
      </div>
      
      <!-- N/B Zone Strip -->
      <div class="mt-3">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted" style="font-size:12px">N/B Zone Status</span>
            <span id="nbZoneTimeframe" class="badge bg-info" style="font-size:10px">-</span>
          </div>
          <span id="nbZoneNow" class="badge bg-secondary">-</span>
        </div>
        <div id="nbZoneStrip" style="height:12px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:6px; overflow:hidden; display:flex; align-items:center; padding:2px">
          <div class="text-muted" style="font-size:11px; padding-left:6px">Loadingâ€¦</div>
        </div>
                      <div class="text-white" style="font-size:11px; margin-top:4px">Visible chart zones (left=older â†’ right=newer)</div>
      </div>

      <!-- Integrated Guild Members & Auto Trading -->
      <div class="mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center mb-1">
          <strong class="text-white" style="font-size:12px">ğŸ° Guild Members</strong>
        </div>
        <div id="integratedGuildStatus" class="mt-1" style="font-size:12px; color:#ffffff; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:6px; padding:8px; min-height:22px">
          <div class="text-muted" style="font-size:11px">Guild ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</div>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">8BIT Upbit Bot - Chart</h3>
      <div class="d-flex align-items-center gap-3">
        <!-- Wave Counter -->
        <div class="d-flex align-items-center gap-2">
          <div class="d-flex align-items-center gap-1">
            <span class="badge bg-primary" style="font-size: 10px;">Blue Wave</span>
            <span id="blueWaveCount" class="badge bg-info" style="font-size: 10px;">5</span>
          </div>
          <div class="d-flex align-items-center gap-1">
            <span class="badge bg-warning" style="font-size: 10px;">Orange Wave</span>
            <span id="orangeWaveCount" class="badge bg-info" style="font-size: 10px;">3</span>
          </div>
          <div class="d-flex align-items-center gap-1">
            <span class="badge bg-secondary" style="font-size: 10px;">Last</span>
            <span id="lastWaveType" class="badge bg-primary" style="font-size: 10px;">BLUE</span>
          </div>
        </div>
        <div class="text-muted" id="meta">-</div>
      </div>
    </div>

    <!-- Top Status + Layout switch: chart left, assets right -->
    <div class="row g-3 align-items-stretch mb-3">
      <div class="col-12 col-lg-2">
        <div id="winCard" class="card border-secondary rounded-3 p-3 h-100 d-flex flex-column" style="background:linear-gradient(180deg, rgba(255,183,3,0.10), rgba(14,20,36,0.85)); box-shadow:0 10px 30px rgba(0,0,0,0.35);">
          <!-- Header -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong class="text-white">Win%</strong>
              <div style="font-size:11px; color:#d9e2f3;">ë¡œì»¬ ìŠ¤ëƒ…ìƒ· + ì„œë²„ íˆìŠ¤í† ë¦¬</div>
            </div>
            <span id="winMajor" class="badge bg-white text-dark">-</span>
          </div>
          
          <!-- Zone Status Section -->
          <div class="win-zone-section mb-3" style="background:rgba(0,0,0,0.25); border-radius:10px; padding:10px;">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="zone-display-label">25ê°œ íˆìŠ¤í† ë¦¬</span>
              <div class="d-flex align-items-center gap-2" style="font-size:11px; color:#d9e2f3;">
                <span id="winLocalCount" class="badge bg-dark text-white">0</span>
                <span id="winServerCount" class="badge bg-secondary text-white">0</span>
              </div>
            </div>
            <div id="zoneConsistencyInfo" class="zone-consistency-display">
              <div class="zone-consistency-content">
                ğŸ”„ <span class="sync-status">ì‹¤ì‹œê°„ ë™ê¸°í™”</span> | 
                N/B: ğŸŸ ORANGE | 
                ML: ğŸ”µBLUE
              </div>
            </div>
          </div>
          
          <!-- Progress Bar -->
          <div id="winFillTrack" class="win-progress-track mb-3" style="height:10px; border-radius:12px;">
            <div id="winFillBar" class="win-progress-bar"></div>
          </div>

          <!-- Trend Chart removed -->
          
          <!-- Win History List -->
          <div id="winList" class="win-history-list flex-grow-1" style="gap:8px;"></div>
        </div>
      </div>


      

      <div class="col-12 col-lg-8">
         <div class="card border-secondary rounded-3 h-100">
           <div class="card-body">
             <div id="tvChart" class="mt-2" style="width: 99%; margin: 0 auto;"></div>
             
             <div class="mt-3"><!-- Auto Buy Controls -->
              <div style="margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">âš™ï¸ Auto Buy (BLUE Zone)</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <!-- ì‹œì‘/ì¤‘ì§€ ë²„íŠ¼ -->
                  <div class="d-flex justify-content-center gap-2 mb-3">
                    <button id="abStartBtn" class="btn btn-sm" style="background: linear-gradient(90deg,#00d1ff,#4285f4); color:#fff; font-weight:600; padding:8px 32px; border:none; border-radius:6px;">
                      â–¶ ì‹œì‘
                    </button>
                    <button id="abStopBtn" class="btn btn-sm" style="background: linear-gradient(90deg,#ff4757,#ff6b81); color:#fff; font-weight:600; padding:8px 32px; border:none; border-radius:6px;">
                      â–  ì¤‘ì§€
                    </button>
                  </div>
                  
                  <!-- ì²´í¬ ê°„ê²© ì„ íƒ (ì…€ë ‰íŠ¸) -->
                  <div style="margin-bottom:10px;">
                    <div style="font-size:10px; color:#9aa8c2; margin-bottom:4px;">ì²´í¬ ê°„ê²© (ì£¼ê¸°)</div>
                    <select id="abInterval" style="width:100%; background:#0e1424; border:1px solid rgba(255,255,255,0.2); color:#e6eefc; border-radius:6px; padding:8px 12px; font-size:13px; font-weight:600;">
                      <option value="">-- ê°„ê²© ì„ íƒ --</option>
                      <option value="minute1">1ë¶„ (1m)</option>
                      <option value="minute5">5ë¶„ (5m)</option>
                      <option value="minute10">10ë¶„ (10m)</option>
                      <option value="minute15">15ë¶„ (15m)</option>
                      <option value="minute30">30ë¶„ (30m)</option>
                      <option value="minute60">1ì‹œê°„ (1h)</option>
                      <option value="minute120">2ì‹œê°„ (2h)</option>
                      <option value="minute240">4ì‹œê°„ (4h)</option>
                      <option value="minute360">6ì‹œê°„ (6h)</option>
                      <option value="minute480">8ì‹œê°„ (8h)</option>
                    </select>
                  </div>
                  
                  <!-- í”„ë¡œê·¸ë ˆìŠ¤ë°” ë° íƒ€ì´ë¨¸ -->
                  <div class="mt-2">
                    <!-- ëŒ€ê¸° ì‹œê°„ í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                    <div id="abWaitPhase" style="display:none;">
                      <div class="d-flex justify-content-between align-items-center" style="font-size:11px; margin-bottom:4px;">
                        <span id="abStatusText" style="color:#ffb703; font-weight:600;">â³ ëŒ€ê¸° ì¤‘...</span>
                        <span id="abWaitTimeText" style="color:#9aa8c2;">-</span>
                      </div>
                      <div style="height:14px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:6px; overflow:hidden; position:relative;">
                        <div id="abWaitProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#ffb703,#ffa500); transition:width .25s linear"></div>
                        <div id="abWaitProgressText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:10px; color:#fff; font-weight:600; text-shadow:0 0 4px #000;">-</div>
                      </div>
                    </div>
                    
                    <!-- ë§¤ìˆ˜ ë‹¨ê³„ í”„ë¡œê·¸ë ˆìŠ¤ë°” -->
                    <div id="abBuyingPhase" style="display:none;">
                      <div class="d-flex justify-content-between align-items-center" style="font-size:11px; margin-bottom:4px;">
                        <span id="abBuyingStatusText" style="color:#0ecb81; font-weight:600;">ğŸ”„ ë§¤ìˆ˜ ì‹œë„ ì¤‘...</span>
                        <span id="abNextBuyText" style="color:#9aa8c2;">-</span>
                      </div>
                      <div style="height:14px; background:#0e1424; border:1px solid rgba(255,255,255,0.12); border-radius:6px; overflow:hidden; position:relative;">
                        <div id="abProgressBar" style="height:100%; width:0%; background:linear-gradient(90deg,#0ecb81,#00d1ff); transition:width .25s linear"></div>
                        <div id="abProgressText" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:10px; color:#fff; font-weight:600; text-shadow:0 0 4px #000;">-</div>
                      </div>
                    </div>
                  </div>
                  <div class="mt-2" style="font-size:10px; color:#9aa8c2;">ğŸ’¡ ëŒ€ê¸° â†’ ë§¤ìˆ˜ ì‹œë„(ì£¼ê¸°ì ) â†’ ì„±ê³µì‹œ ì¬ëŒ€ê¸°</div>
                </div>
              </div>
            </div>

            <div class="mt-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <strong class="text-white">Model Narrative (EN)</strong>
                <span id="nbNarrativeBadge" class="badge bg-secondary">-</span>
              </div>
              <div id="nbNarrative" style="font-size:13px; color:#e6eefc; background:#0e1424; border:1px solid rgba(255,255,255,0.1); border-radius:6px; padding:10px; min-height:52px">-</div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-2">
        <div id="currentCard" class="card border-secondary rounded-3 p-3 h-100 d-flex flex-column" style="min-height:240px; background: linear-gradient(135deg, rgba(30,35,41,0.9), rgba(14,20,36,0.9));">
          <!-- í—¤ë” -->
          <div class="d-flex justify-content-between align-items-center mb-3" style="border-bottom: 2px solid rgba(0,209,255,0.3); padding-bottom: 10px;">
            <div>
              <strong class="text-white" style="font-size: 16px;">ğŸ“Š í˜„ì¬ ì¹´ë“œ</strong>
              <div style="font-size: 10px; margin-top: 6px;">
                <div class="text-muted" id="ccTimestamp">-</div>
                <div style="color: #00d1ff; font-weight: 600; margin-top: 3px;">ë¶„ë´‰: <span id="ccTimeframeDisplay">10m</span></div>
              </div>
            </div>
            <span id="ccInterval" class="badge bg-info" style="font-size: 10px; padding: 4px 8px;">-</span>
          </div>
          
          <!-- ì¹´ë“œ ë“±ê¸‰ ì„¹ì…˜ -->
          <div id="ccRatingSection" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.2);">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted" style="font-size: 10px; margin-bottom: 4px;">ì¹´ë“œ ë“±ê¸‰</div>
                <div id="ccRatingDisplay" style="font-size: 18px; font-weight: 700;">-</div>
              </div>
              <div class="text-end">
                <div class="text-muted" style="font-size: 10px; margin-bottom: 4px;">ì ìˆ˜</div>
                <div id="ccRatingScore" style="font-size: 16px; font-weight: 600; color: #00d1ff;">-</div>
              </div>
            </div>
          </div>
          
          <!-- í˜„ì¬ ê°€ê²© ì„¹ì…˜ (ê°•ì¡°) -->
          <div style="background: rgba(0,209,255,0.1); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(0,209,255,0.3);">
            <div class="text-muted" style="font-size: 10px; margin-bottom: 4px;">í˜„ì¬ ê°€ê²©</div>
            <div id="ccPrice" style="font-size: 20px; font-weight: 700; color: #00d1ff; word-break: break-all;">-</div>
          </div>
          
          <!-- ê±°ë˜ëŸ‰ & ê±°ë˜ëŒ€ê¸ˆ ì„¹ì…˜ -->
          <div class="row g-2" style="margin-bottom: 12px;">
            <div class="col-6">
              <div style="background: rgba(14,203,129,0.1); border-radius: 8px; padding: 10px; border: 1px solid rgba(14,203,129,0.3);">
                <div class="text-muted" style="font-size: 9px; margin-bottom: 4px;">ê±°ë˜ëŸ‰</div>
                <div id="ccVolume" style="font-size: 14px; font-weight: 700; color: #0ecb81; word-break: break-all;">-</div>
              </div>
            </div>
            <div class="col-6">
              <div style="background: rgba(66,133,244,0.1); border-radius: 8px; padding: 10px; border: 1px solid rgba(66,133,244,0.3);">
                <div class="text-muted" style="font-size: 9px; margin-bottom: 4px;">ê±°ë˜ëŒ€ê¸ˆ</div>
                <div id="ccTurnover" style="font-size: 14px; font-weight: 700; color: #4285f4; word-break: break-all;">-</div>
              </div>
            </div>
          </div>
          
          <!-- ê°€ê²© N/B ì„¹ì…˜ -->
          <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’° ê°€ê²© N/B</div>
            <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted" style="font-size: 10px;">MAX</span>
                <span id="ccPriceMax" style="font-size: 11px; font-weight: 600; color: #0ecb81;">-</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted" style="font-size: 10px;">MIN</span>
                <span id="ccPriceMin" style="font-size: 11px; font-weight: 600; color: #f6465d;">-</span>
              </div>
            </div>
          </div>
          
          <!-- ê±°ë˜ëŸ‰ N/B ì„¹ì…˜ -->
          <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“ˆ ê±°ë˜ëŸ‰ N/B</div>
            <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted" style="font-size: 10px;">MAX</span>
                <span id="ccVolMax" style="font-size: 11px; font-weight: 600; color: #2bdab5;">-</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted" style="font-size: 10px;">MIN</span>
                <span id="ccVolMin" style="font-size: 11px; font-weight: 600; color: #ffb703;">-</span>
              </div>
            </div>
          </div>
          
          <!-- ê±°ë˜ëŒ€ê¸ˆ N/B ì„¹ì…˜ -->
          <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’µ ê±°ë˜ëŒ€ê¸ˆ N/B</div>
            <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted" style="font-size: 10px;">MAX</span>
                <span id="ccTurnMax" style="font-size: 11px; font-weight: 600; color: #4285f4;">-</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted" style="font-size: 10px;">MIN</span>
                <span id="ccTurnMin" style="font-size: 11px; font-weight: 600; color: #9c27b0;">-</span>
              </div>
            </div>
          </div>
          
          <!-- ìš”ì•½ ê·¸ë˜í”„ -->
          <div style="margin-bottom: 12px; position: relative; height: 80px;">
            <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“Š ì¶”ì´ ê·¸ë˜í”„</div>
            <canvas id="ccSummaryChart" style="position: absolute; top: 20px; left: 0; width: 100%; height: 60px !important;"></canvas>
          </div>
          
          <!-- N/B Zone Status ì„¹ì…˜ -->
          <div style="margin-bottom: 12px;">
            <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ—ºï¸ N/B Zone</div>
            <div id="ccNBZone" style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1); font-size: 10px; color: #e6eefc; min-height: 20px; word-break: break-word;">-</div>
          </div>
          
          
          <!-- í˜„ì¬ ì¹´ë“œ: íŒë§¤ ì‹¤í˜„ ì†ìµ í‘œì‹œ -->
          <div class="col-12">
            <div class="row g-2 mt-2">
              <div class="col-6">
                <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 8px;">
                  <div class="text-muted" style="font-size: 10px;">íŒë§¤ í‰ê·  ì‹¤í˜„ ì†ìµ</div>
                  <div id="ccRealizedAvg" style="font-size: 14px; font-weight: 700;">0 KRW</div>
                </div>
              </div>
              <div class="col-6">
                <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 8px;">
                  <div class="text-muted" style="font-size: 10px;">íŒë§¤ ìµœê³  ì‹¤í˜„ ì†ìµ</div>
                  <div id="ccRealizedMax" style="font-size: 14px; font-weight: 700;">0 KRW</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ë²„íŠ¼ ë° ìƒíƒœ -->
          <div class="mt-auto pt-2">
            <div style="margin-bottom: 8px;">
              <div class="d-flex align-items-center gap-2 mb-2">
                <label class="text-muted" style="font-size: 11px; white-space: nowrap;">ë§¤ìˆ˜ ê¸ˆì•¡</label>
                <input id="ccBuyAmount" type="number" value="5000" min="1000" step="1000" class="form-control form-control-sm" style="flex: 1;" />
              </div>
              <div class="d-grid gap-2">
                <button id="ccBuy" class="btn btn-sm btn-success">ğŸ›’ í˜„ì¬ ì¹´ë“œ ë§¤ìˆ˜</button>
                <button id="ccRefresh" class="btn btn-sm btn-outline-info">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
              </div>
            </div>
            <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
              <button id="ccSave" class="btn btn-sm btn-primary w-100 mb-2">ğŸ’¾ NBverse ì €ì¥</button>
              <div style="font-size: 11px; font-weight: 600; color: #2ecc71; text-align: center;">
                <span id="ccSaveHint">ëŒ€ê¸°</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë§¤ìˆ˜/ë§¤ë„ í†µê³„ ì„¹ì…˜ -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3 class="m-0">ê±°ë˜ í†µê³„</h3>
          <button id="tradeStatsRefresh" class="btn btn-sm btn-outline-info">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>
      
    <!-- ìì‚° ìš”ì•½ -->
    <div class="card border-secondary rounded-3 p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-2">
          <strong class="text-white">ìì‚°</strong>
          <span id="assetsMeta" class="text-muted" style="font-size:11px">-</span>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" id="assetsAuto" checked>
            <label class="form-check-label text-muted" for="assetsAuto" style="font-size:11px">ìë™</label>
          </div>
          <button id="assetsRefresh" class="btn btn-sm btn-outline-info">ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <div class="row g-2 mb-3">
        <div class="col-12 col-md-4">
          <div class="asset-stat">
            <div class="label">ì´ ìì‚° (KRW í™˜ì‚°)</div>
            <div class="value" id="assetTotal">-</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="asset-stat">
            <div class="label">ë³´ìœ  KRW</div>
            <div class="value" id="assetBuyable">-</div>
          </div>
        </div>
        <div class="col-12 col-md-4">
          <div class="asset-stat">
            <div class="label">ë§¤ë„ ê°€ëŠ¥ ì½”ì¸</div>
            <div class="value" id="assetSellable">-</div>
          </div>
        </div>
      </div>

      <div class="asset-bars" id="assetsBars"></div>
    </div>

      <!-- ë§¤ìˆ˜ ì™„ë£Œ ì¹´ë“œ -->
      <div class="col-12 col-md-6">
        <div class="card border-success rounded-3 p-3" style="background: linear-gradient(135deg, rgba(14,203,129,0.1), rgba(14,203,129,0.05));">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="m-0" style="color: #0ecb81;">ğŸ›’ ë§¤ìˆ˜ ì™„ë£Œ ì¹´ë“œ</h5>
              <small class="text-muted" id="buyStatsTime">-</small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="exportBuyCards" class="btn btn-sm btn-outline-success" title="ë§¤ìˆ˜ ì¹´ë“œ ë‚´ë³´ë‚´ê¸°">ğŸ’¾ JSON</button>
              <span id="buyCount" class="badge bg-success" style="font-size: 16px;">0</span>
            </div>
          </div>
          
          <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px; max-height: 600px; overflow-y: auto;">
            <div id="buyOrderList" style="font-size: 12px; color: #e6eefc;">
              <div class="text-center text-muted py-2">ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- ë§¤ë„ ì™„ë£Œ ì¹´ë“œ -->
      <div class="col-12 col-md-6">
        <div class="card border-danger rounded-3 p-3" style="background: linear-gradient(135deg, rgba(246,70,93,0.1), rgba(246,70,93,0.05));">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="m-0" style="color: #f6465d;">ğŸ’° ë§¤ë„ ì™„ë£Œ</h5>
              <small class="text-muted" id="sellStatsTime">-</small>
            </div>
            <div class="d-flex align-items-center gap-2">
              <button id="exportSellCards" class="btn btn-sm btn-outline-danger" title="ë§¤ë„ ì¹´ë“œ ë‚´ë³´ë‚´ê¸°">ğŸ’¾ JSON</button>
              <span id="sellCount" class="badge bg-danger" style="font-size: 16px;">0</span>
            </div>
          </div>
          
          <div class="row g-2 mb-3">
            <div class="col-6">
              <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px;">
                <div class="text-muted" style="font-size: 10px;">ì´ ë§¤ë„ ê¸ˆì•¡</div>
                <div id="sellTotalAmount" style="font-size: 16px; font-weight: 700; color: #f6465d;">0 KRW</div>
              </div>
            </div>
            <div class="col-6">
              <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px;">
                <div class="text-muted" style="font-size: 10px;">í‰ê·  ë§¤ë„ê°€</div>
                <div id="sellAvgPrice" style="font-size: 16px; font-weight: 700; color: #f6465d;">0 KRW</div>
              </div>
            </div>
          </div>
          
          <div class="row g-2 mb-3">
            <div class="col-6">
              <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px;">
                <div class="text-muted" style="font-size: 10px;">ì´ ìˆ˜ìµ</div>
                <div id="totalProfit" style="font-size: 16px; font-weight: 700;">0 KRW</div>
              </div>
            </div>
            <div class="col-6">
              <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px;">
                <div class="text-muted" style="font-size: 10px;">ìˆ˜ìµë¥ </div>
                <div id="profitRate" style="font-size: 16px; font-weight: 700;">0%</div>
              </div>
            </div>
          </div>
          
          <div style="background: rgba(14,20,36,0.6); border-radius: 6px; padding: 10px; max-height: 100%; overflow-y: auto;">
            <div class="text-muted mb-2" style="font-size: 11px;">ìµœê·¼ ë§¤ë„ ë‚´ì—­</div>
            <div id="sellOrderList" style="font-size: 12px; color: #e6eefc;">
              <div class="text-center text-muted py-2">ë§¤ë„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë§¤ìˆ˜/ë§¤ë„ ë¡œê·¸ ì„¹ì…˜ -->
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card border-secondary rounded-3 p-3" style="background: rgba(14,20,36,0.6);">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="m-0">ê±°ë˜ ë¡œê·¸</h5>
            <button id="tradeLogRefresh" class="btn btn-sm btn-outline-info">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
          </div>
          <div id="tradeLogList" style="max-height: 220px; overflow-y: auto; font-size: 12px; color: #e6eefc;">
            <div class="text-center text-muted py-2">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
          </div>
        </div>
      </div>
    </div>

        <div class="card border-secondary rounded-3 p-3">
          <div class="row g-2 align-items-center mb-3 toolbar">
            <div class="col-auto">
              <select id="timeframe" class="form-select form-select-sm">
                <option value="minute1">1m</option>
                <option value="minute3">3m</option>
                <option value="minute5">5m</option>
                <option value="minute10" selected>10m</option>
                <option value="minute15">15m</option>
                <option value="minute30">30m</option>
                <option value="minute60">1h</option>
                <option value="day">1D</option>
              </select>
            </div>
            <div class="col-auto"><button id="botStart" class="btn btn-primary btn-sm">Start Bot</button></div>
            <div class="col-auto"><button id="botStop" class="btn btn-outline-light btn-sm">Stop Bot</button></div>
            <div class="col-auto"><button id="btnShot" class="btn btn-secondary btn-sm">Screenshot</button></div>
            <div class="col-auto"><button id="btnBacktest" class="btn btn-outline-info btn-sm">Backtest</button></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="autoBtToggle">
              <label class="form-check-label text-muted" for="autoBtToggle">Auto BT</label>
            </div>
            <div class="col-auto text-muted">sec</div>
            <div class="col-auto"><input id="autoBtSec" type="number" value="60" min="10" step="10" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto"><button id="btnOptimize" class="btn btn-success btn-sm">Auto-Tune NB</button></div>
            <div class="col-auto"><button id="btnTrain" class="btn btn-warning btn-sm">Train (Auto Period)</button></div>
            <div class="col-auto text-muted">Cnt</div>
            <div class="col-auto"><input id="trainCount" type="number" value="1800" min="300" step="300" class="form-control form-control-sm" style="width:90px" /></div>
            <div class="col-auto text-muted">Seg</div>
            <div class="col-auto"><input id="trainSeg" type="number" value="3" min="2" step="1" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto"><button id="btnMlTrain" class="btn btn-danger btn-sm">ML Train</button></div>
            <div class="col-auto"><button id="btnMlPredict" class="btn btn-outline-danger btn-sm">ML Predict</button></div>
            <div class="col-12 col-lg-4">
              <div class="card border-secondary rounded-3 p-2" style="min-height:80px">
                <div class="d-flex justify-content-between align-items-center mb-1">
                  <strong class="text-white">Model Insight</strong>
                  <span id="miZone" class="badge bg-secondary">-</span>
                </div>
                <div id="miText" style="font-size:12px; color:#e6eefc">-</div>
              </div>
            </div>
            <div class="col-auto"><button id="btnMlMetrics" class="btn btn-outline-warning btn-sm">ML Metrics</button></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="mlAuto">
              <label class="form-check-label text-muted" for="mlAuto">ML Auto</label>
            </div>
            <div class="col-auto text-muted">N</div>
            <div class="col-auto"><input id="mlRandN" type="number" value="12" min="1" step="1" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto"><button id="btnMlRandom" class="btn btn-outline-warning btn-sm">ML Random</button></div>
            <div class="col-auto"><button id="btnClearOrders" class="btn btn-outline-danger btn-sm">Clear Orders</button></div>
            <div class="col-auto text-muted">NB Window</div>
            <div class="col-auto"><input id="nbWindow" type="number" value="100" min="20" step="10" class="form-control form-control-sm" style="width:90px" /></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="nbToggle" checked>
              <label class="form-check-label text-muted" for="nbToggle">Show NB</label>
            </div>
            <div class="col-12"></div>
            <div class="col-auto text-muted">BUYâ‰¥r</div>
            <div class="col-auto"><input id="nbBuyTh" type="number" value="0.70" min="0.5" max="0.95" step="0.01" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto text-muted">SELLâ‰¤r</div>
            <div class="col-auto"><input id="nbSellTh" type="number" value="0.30" min="0.05" max="0.5" step="0.01" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto text-muted">Pullback%</div>
            <div class="col-auto"><input id="nbPullback" type="number" value="40" min="10" max="80" step="1" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto text-muted">Debounce</div>
            <div class="col-auto"><input id="nbDebounce" type="number" value="6" min="0" max="20" step="1" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto text-muted">Forecast</div>
            <div class="col-auto"><input id="fcWindow" type="number" value="50" min="10" step="5" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto"><input id="fcHorizon" type="number" value="30" min="1" step="1" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="fcToggle" checked>
              <label class="form-check-label text-muted" for="fcToggle">Show</label>
            </div>
            
            <div class="col-auto text-muted">Paper</div>
            <div class="col-auto">
              <select id="paperMode" class="form-select form-select-sm">
                <option value="true" selected>true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div class="col-auto text-muted">Order KRW</div>
            <div class="col-auto"><input id="orderKrw" type="number" value="5000" min="1000" step="1000" class="form-control form-control-sm" style="width:110px" /></div>
            <div class="col-auto text-muted">EMA</div>
            <div class="col-auto"><input id="emaFast" type="number" value="10" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto">/</div>
            <div class="col-auto"><input id="emaSlow" type="number" value="30" class="form-control form-control-sm" style="width:80px" /></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="emaFilter" checked>
              <label class="form-check-label text-muted" for="emaFilter">EMA Filter</label>
            </div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="nbFromEma">
              <label class="form-check-label text-muted" for="nbFromEma">NB from EMA</label>
            </div>
            <div class="col-auto text-muted">NB EMA</div>
            <div class="col-auto"><input id="nbEmaPeriod" type="number" value="10" min="2" step="1" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-12"></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showSMA" checked>
              <label class="form-check-label text-muted" for="showSMA">SMA</label>
            </div>
            <div class="col-auto text-muted">50</div>
            <div class="col-auto"><input id="sma50" type="number" value="50" min="5" step="5" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto text-muted">100</div>
            <div class="col-auto"><input id="sma100" type="number" value="100" min="10" step="5" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto text-muted">200</div>
            <div class="col-auto"><input id="sma200" type="number" value="200" min="20" step="10" class="form-control form-control-sm" style="width:70px" /></div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showEMA9" checked>
              <label class="form-check-label text-muted" for="showEMA9">EMA 9/12/26</label>
            </div>
            <div class="col-auto text-muted">Ichimoku</div>
            <div class="col-auto form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showIchimoku">
              <label class="form-check-label text-muted" for="showIchimoku">Tenkan/Kijun</label>
            </div>
            <div class="col-auto text-muted">9</div>
            <div class="col-auto"><input id="ichiTenkan" type="number" value="9" min="5" step="1" class="form-control form-control-sm" style="width:60px" /></div>
            <div class="col-auto text-muted">26</div>
            <div class="col-auto"><input id="ichiKijun" type="number" value="26" min="10" step="1" class="form-control form-control-sm" style="width:60px" /></div>
          </div>
          <hr class="text-secondary"/>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="text-white">Live Log</strong>
            <div>
              <button id="btnClearLog" class="btn btn-sm btn-outline-light me-2">Clear</button>
              <div class="form-check form-switch d-inline-block">
                <input class="form-check-input" type="checkbox" id="logAutoscroll">
                <label class="form-check-label text-muted" for="logAutoscroll">Auto</label>
              </div>
            </div>
          </div>
          <pre id="logBox" style="height:160px;overflow:auto;overflow-anchor:none;background:#0e1424;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px;margin:0;color:#a7b4d7;font-size:12px;line-height:1.35"></pre>
          <div id="mlMetricsBox" class="mt-2" style="font-size:12px;color:#e6eefc"></div>
        </div>
      </div>
    </div>
  </div>

     <!-- Orders Log Bottom Section -->
   <div class="row g-3 justify-content-center mt-3">
     <div class="col-12">
       <div class="card border-secondary rounded-3 p-3">
         <div class="d-flex justify-content-between align-items-center mb-2">
           <strong class="text-white">Order Log</strong>
           <div>
             <button id="btnOrderExport" class="btn btn-sm btn-outline-light me-2">Export CSV</button>
             <button id="btnOrderClear" class="btn btn-sm btn-outline-danger">Clear</button>
           </div>
         </div>
         <div id="orderLog" style="height:180px;overflow:auto;overflow-anchor:none;background:#0e1424;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:8px;margin:0;color:#e6eefc;font-size:12px;line-height:1.35"></div>
       </div>
     </div>
   </div>
   </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://unpkg.com/masonry-layout@4.2.2/dist/masonry.pkgd.min.js"></script>
  <!-- Disabled to stop repeated timeouts/readyState errors during trading UI use -->
  <!-- <script src="/static/mayor-guidance.js?v=dev"></script> -->
  <!-- <script src="/static/village-trading-process.js?v=dev"></script> -->
  <script src="/static/trainer-system.js?v=dev"></script>
  <script src="/static/village-learning-system.js?v=dev"></script>
  <script src="/static/guild-members-status.js?v=dev"></script>
  <script src="/static/trust-module.js?v=dev"></script>
  <script src="/static/card-rating-system.js?v=dev"></script>
  <script src="/static/ui.js?v=dev"></script>
  <!-- External N/B calculation library (overrides local BIT_* functions) -->
  <script src="https://xn--9l4b4xi9r.com/_8%EB%B9%84%ED%8A%B8/js/bitCalculation.v.0.2.js"></script>
  
  <!-- ë¶„ë´‰ ì¹´ë“œ ê¸°ëŠ¥ ìŠ¤í¬ë¦½íŠ¸ -->
  <script>
    let ccSummaryChart = null; // ê¸€ë¡œë²Œ ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤
    let currentActiveTimeframe = 'minute10'; // í˜„ì¬ í™œì„± ë¶„ë´‰ ì¶”ì 
    window.currentActiveTimeframe = currentActiveTimeframe; // ì „ì—­ ë™ê¸°í™”
    const WIN_LS_KEY = 'winClientHistoryV1';
    let winTrendChart = null;

    function restoreWinHistoryFromLocal() {
      try {
        const raw = localStorage.getItem(WIN_LS_KEY);
        const parsed = raw ? JSON.parse(raw) : [];
        if (Array.isArray(parsed)) {
          window.winClientHistory = parsed;
        } else {
          window.winClientHistory = [];
        }
      } catch (_) {
        window.winClientHistory = [];
      }
    }

    function persistWinHistoryToLocal() {
      try {
        const list = Array.isArray(window.winClientHistory) ? window.winClientHistory.slice(0, 200) : [];
        localStorage.setItem(WIN_LS_KEY, JSON.stringify(list));
      } catch (_) {}
    }
    
    // í˜„ì¬ ì¹´ë“œ ìŠ¤ëƒ…ìƒ·ì„ Win% í‘œì‹œìš©ìœ¼ë¡œ ì ì¬ (ì„¸ì…˜ ë‚´ ëˆ„ì )
    function addCurrentWinSnapshot() {
      try {
        const cc = window.ccCurrentData;
        const cr = window.ccCurrentRating;
        if (!cc || !cr) {
          console.warn('âš ï¸ Win% ìŠ¤ëƒ…ìƒ· ìŠ¤í‚µ: í˜„ì¬ ì¹´ë“œ ë°ì´í„° ì—†ìŒ');
          return;
        }
        
        const tf = window.currentActiveTimeframe || cc.interval || 'minute10';
        const nowIso = new Date().toISOString();
        if (!window.winClientHistory) window.winClientHistory = [];

        // Zoneì€ DOMì—ì„œ ì½ê±°ë‚˜ ì „ì—­ ë³€ìˆ˜ ì‚¬ìš©
        let zone = window.ccCurrentZone || null;
        if (!zone) {
          try {
            const zoneEl = document.getElementById('ccNBZone');
            if (zoneEl) {
              const txt = zoneEl.textContent || '';
              if (txt.includes('BLUE')) zone = 'BLUE';
              else if (txt.includes('ORANGE')) zone = 'ORANGE';
            }
          } catch(_) {}
        }

        const last = window.winClientHistory[0];
        // ì¤‘ë³µ ë°©ì§€: ê°™ì€ TFì—ì„œ ë™ì¼ ì½”ë“œê°€ 2ì´ˆ ì´ë‚´ ì¬ì ì¬ ì‹œ ìŠ¤í‚µ
        if (last) {
          const dt = Math.abs(new Date(nowIso).getTime() - new Date(last.ts).getTime());
          if (last.tf === tf && last.code === cr.code && dt < 2000) {
            console.log('â­ï¸ Win% ìŠ¤ëƒ…ìƒ· ì¤‘ë³µ ìŠ¤í‚µ:', cr.code);
            return;
          }
        }

        // Zoneì´ NONEì´ë©´ ìŠ¤ëƒ…ìƒ· ì¶”ê°€ ì•ˆ í•¨
        if (!zone || zone === '-' || zone === 'NONE') {
          console.log('â­ï¸ Win% ìŠ¤ëƒ…ìƒ· ìŠ¤í‚µ: Zoneì´ ì—†ìŒ ('+zone+')');
          return;
        }
        
        const entry = {
          ts: nowIso,
          tf,
          zone,
          code: cr.code,
          league: cr.league,
          group: cr.group,
          super: !!cr.super,
          avgPts: cr.avgPts,
          enhancement: cr.mlEnhancement || cr.enhancement || 1,
          mlGrade: cr.mlGrade || null,
          mlEnhancement: cr.mlEnhancement || null
        };
        window.winClientHistory.unshift(entry);
        // ê¸¸ì´ ì œí•œ
        window.winClientHistory = window.winClientHistory.slice(0, 200);
        persistWinHistoryToLocal();
        console.log('âœ… Win% ìŠ¤ëƒ…ìƒ· ì¶”ê°€:', entry.code, entry.tf, 'Zone='+entry.zone, 'total='+window.winClientHistory.length);
        
        // Win% íŒ¨ë„ ì¦‰ì‹œ ê°±ì‹ 
        try { if (typeof loadWinHistory === 'function') setTimeout(loadWinHistory, 0); } catch(_) {}
      } catch (e) {
        console.warn('âŒ addCurrentWinSnapshot ì‹¤íŒ¨:', e?.message);
      }
    }
    
    // í˜„ì¬ ì¹´ë“œ ë¡œë”
    function loadCurrentCard() {
      // currentActiveTimeframe ì‚¬ìš© (timeframe select ìš”ì†Œë³´ë‹¤ ë” ì‹ ë¢°ì„± ìˆìŒ)
      const interval = (window.currentActiveTimeframe || currentActiveTimeframe || 'minute10');
      document.getElementById('ccInterval').textContent = interval;
      
      // ë¶„ë´‰ í‘œì‹œ ì—…ë°ì´íŠ¸
      const timeframeMap = {
        'minute1': '1m',
        'minute3': '3m',
        'minute5': '5m',
        'minute10': '10m',
        'minute15': '15m',
        'minute30': '30m',
        'minute60': '1h',
        'day': '1D'
      };
      const displayTimeframe = timeframeMap[interval] || interval;
      const ccTimeframeDisplay = document.getElementById('ccTimeframeDisplay');
      if (ccTimeframeDisplay) {
        ccTimeframeDisplay.textContent = displayTimeframe;
      }
      
      // í˜„ì¬ ì‹œê°„ ì—…ë°ì´íŠ¸
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ko-KR');
      document.getElementById('ccTimestamp').textContent = timeStr;
      // ë¡œë”© í”Œë˜ê·¸ ì„¤ì • (ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€)
      window.isLoadingCurrentCard = true;
      
      const url = `/api/nbverse/card?interval=${encodeURIComponent(interval)}&count=300&save=true`;
      fetch(url).then(r => {
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
      }).then(j => {
        if (!j || !j.ok) { throw new Error(j && j.error ? j.error : 'failed'); }
        
        // í˜„ì¬ ê°€ê²©
        document.getElementById('ccPrice').textContent = j.current_price != null ? j.current_price.toLocaleString() : '-';
        
        // í˜„ì¬ ê±°ë˜ëŸ‰ê³¼ ê±°ë˜ëŒ€ê¸ˆ ê³„ì‚° (chart ë°ì´í„°ì˜ ë§ˆì§€ë§‰ ê°’)
        if (j.chart && j.chart.length > 0) {
          const lastCandle = j.chart[j.chart.length - 1];
          const currentVolume = lastCandle.volume || 0;
          const currentTurnover = (j.current_price || 0) * currentVolume;
          
          // ê±°ë˜ëŸ‰ í‘œì‹œ (8ìë¦¬ê¹Œì§€)
          document.getElementById('ccVolume').textContent = 
            currentVolume > 0 ? Number(currentVolume).toFixed(8) : '-';
          
          // ê±°ë˜ëŒ€ê¸ˆ í‘œì‹œ (ì •ìˆ˜ ë˜ëŠ” ì†Œìˆ˜ì  2ìë¦¬)
          document.getElementById('ccTurnover').textContent = 
            currentTurnover > 0 ? Number(currentTurnover).toLocaleString('ko-KR', {maximumFractionDigits: 0}) : '-';
        }
        
        // N/B ê°’ë“¤
        const nb = j.nb || {};
        const price = nb.price || {};
        const volume = nb.volume || {};
        const turnover = nb.turnover || {};
        const fmt = (v) => (v == null ? '-' : Number(v).toFixed(10));
        
        document.getElementById('ccPriceMax').textContent = fmt(price.max);
        document.getElementById('ccPriceMin').textContent = fmt(price.min);
        document.getElementById('ccVolMax').textContent = fmt(volume.max);
        document.getElementById('ccVolMin').textContent = fmt(volume.min);
        document.getElementById('ccTurnMax').textContent = fmt(turnover.max);
        document.getElementById('ccTurnMin').textContent = fmt(turnover.min);
        
        // ì €ì¥í•  í˜„ì¬ ì¹´ë“œ ë°ì´í„° ì „ì—­ ë³€ìˆ˜ ì €ì¥
        window.ccCurrentData = {
          interval: interval,
          timestamp: new Date().toISOString(),
          current_price: j.current_price,
          current_volume: j.chart && j.chart.length > 0 ? j.chart[j.chart.length - 1].volume : 0,
          current_turnover: j.current_price * (j.chart && j.chart.length > 0 ? j.chart[j.chart.length - 1].volume : 0),
          nb: {
            price: { max: price.max, min: price.min, values: price.values || [] },
            volume: { max: volume.max, min: volume.min, values: volume.values || [] },
            turnover: { max: turnover.max, min: turnover.min, values: turnover.values || [] }
          },
          chart: j.chart || []
        };
        
        // ì €ì¥ ìƒíƒœ
        const saveMeta = j.save && j.save.paths ? j.save.paths : null;
        document.getElementById('ccSaveHint').textContent = saveMeta ? 'âœ… ì™„ë£Œ' : 'â³ ëŒ€ê¸°';
        
        // ìš”ì•½ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        if (price.values && price.values.length > 0) {
          drawSummaryChart(price.values, volume.values, turnover.values);
        }

        // N/B Zone Status í‘œì‹œ (ë¹„ë™ê¸°, ë°±ê·¸ë¼ìš´ë“œ)
        fetchNBZoneStatus(interval);

        // rê¸°ë°˜ ì¹´ë“œ ì½”ë“œ/ë¦¬ê·¸/ê·¸ë£¹/SUPER ê³„ì‚° ë° í‘œì‹œ
        calculateAndDisplayCardRating({
          priceMax: price.max,
          priceMin: price.min,
          volumeMax: volume.max,
          volumeMin: volume.min,
          amountMax: turnover.max,
          amountMin: turnover.min
        });
        
        // í˜„ì¬ ì¹´ë“œ ë Œë”ë§ ì™„ë£Œ â†’ Win% ìŠ¤ëƒ…ìƒ· ì¦‰ì‹œ ì¶”ê°€
        setTimeout(() => {
          try {
            addCurrentWinSnapshot();
          } catch (e) {
            console.error('âŒ addCurrentWinSnapshot ì—ëŸ¬:', e);
          }
        }, 0);
        
        // ìë™ ì €ì¥: NBverseì— í˜„ì¬ ì¹´ë“œ ë°ì´í„° ì €ì¥
        autoSaveCurrentCard();
        
        console.log('âœ… loadCurrentCard completed', j);
      }).catch(err => {
        document.getElementById('ccSaveHint').textContent = 'âŒ ì˜¤ë¥˜';
        console.error('loadCurrentCard error', err);
        // ì—ëŸ¬ ì‹œ ê¸°ë³¸ê°’ í‘œì‹œ
        document.getElementById('ccPrice').textContent = '-';
        document.getElementById('ccVolume').textContent = '-';
        document.getElementById('ccTurnover').textContent = '-';
        const zoneEl = document.getElementById('ccNBZone');
        if (zoneEl) zoneEl.textContent = 'âš ï¸ ì¡°íšŒ ì‹¤íŒ¨';
      }).finally(() => {
        window.isLoadingCurrentCard = false;
      });
    }
    
      // í˜„ì¬ ì¹´ë“œ ìë™ ì €ì¥
    function autoSaveCurrentCard() {
      if (!window.ccCurrentData) return;
      
      try {
        // postJson í•¨ìˆ˜ ì²´í¬
        if (typeof postJson !== 'function') {
          // postJsonì´ ì—†ìœ¼ë©´ fetch ì§ì ‘ ì‚¬ìš©
          fetch('/api/nbverse/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(window.ccCurrentData)
          }).then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
          }).then(result => {
            if (result && result.ok) {
              console.log('âœ… ìë™ ì €ì¥ ì™„ë£Œ:', window.ccCurrentData.interval);
              try { window.ccLastNbversePath = result.path; } catch(_) {}
            }
          }).catch(err => {
            console.warn('âš ï¸ ìë™ ì €ì¥ ì—ëŸ¬:', err.message);
          });
          return;
        }
        
        // postJson í•¨ìˆ˜ë¡œ ì €ì¥ ì‹œë„
        if (typeof postJson === 'function') {
          postJson('/api/nbverse/save', window.ccCurrentData).then(result => {
            if (result && result.ok) {
              console.log('âœ… ìë™ ì €ì¥ ì™„ë£Œ:', window.ccCurrentData.interval);
              try { window.ccLastNbversePath = result.path; } catch(_) {}
            } else {
              console.warn('âš ï¸ ìë™ ì €ì¥ ì‹¤íŒ¨:', result?.error || 'Unknown');
            }
          }).catch(err => {
            console.warn('âš ï¸ ìë™ ì €ì¥ ì—ëŸ¬:', err.message);
          });
        } else {
          // postJsonì´ ì—†ìœ¼ë©´ fetch ì‚¬ìš©
          fetch('/api/nbverse/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(window.ccCurrentData)
          }).then(r => r.json()).then(result => {
            if (result && result.ok) {
              console.log('âœ… ìë™ ì €ì¥ ì™„ë£Œ:', window.ccCurrentData.interval);
              try { window.ccLastNbversePath = result.path; } catch(_) {}
            } else {
              console.warn('âš ï¸ ìë™ ì €ì¥ ì‹¤íŒ¨:', result?.error || 'Unknown');
            }
          }).catch(err => {
            console.warn('âš ï¸ ìë™ ì €ì¥ ì—ëŸ¬:', err.message);
          });
        }
      } catch (err) {
        console.warn('âš ï¸ ìë™ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', err.message);
      }
    }
    
    // N/B Zone Status ì¡°íšŒ ë° í‘œì‹œ
    function fetchNBZoneStatus(interval) {
      const url = `/api/nbverse/zone?interval=${encodeURIComponent(interval)}`;

      return fetch(url)
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          return r.json();
        })
        .then(j => {
          if (j && j.ok) {
            const zoneEl = document.getElementById('ccNBZone');
            const currentZone = j.current_zone || '-';
            window.ccCurrentZone = currentZone; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            
            if (zoneEl) {
              const zoneLabel = currentZone === 'BLUE' ? 'ğŸ”µ BLUE' : currentZone === 'ORANGE' ? 'ğŸŸ  ORANGE' : 'âšª NONE';
              const zoneCount = j.zone_count || '-';
              const zoneColor = currentZone === 'BLUE' ? '#00d1ff' : currentZone === 'ORANGE' ? '#ffb703' : '#888888';

              zoneEl.innerHTML = `
                <div style="text-align: center;">
                  <div style="font-size: 13px; font-weight: 700; color: ${zoneColor}; margin-bottom: 4px;">
                    ${zoneLabel}
                  </div>
                  <div style="font-size: 10px; color: #d9e2f3;">ì§€ë‚œ ${zoneCount || '?'}ê°œ êµ¬ê°„</div>
                </div>
              `;
            }

            console.log('âœ… N/B Zone Status updated:', currentZone, j.zone_count);
            return currentZone;
          } else {
            console.warn('âš ï¸ fetchNBZoneStatus failed:', j);
            const zoneEl = document.getElementById('ccNBZone');
            if (zoneEl) zoneEl.textContent = 'ë°ì´í„° ì—†ìŒ';
            return null;
          }
        })
        .catch(err => {
          console.error('fetchNBZoneStatus error', err);
          const zoneEl = document.getElementById('ccNBZone');
          if (zoneEl) zoneEl.textContent = 'ì¡°íšŒ ì¤‘...';
          return null;
        });
    }
    
    // ìˆœìˆ˜ ê³„ì‚°ê¸°: N/Bë¡œ ì½”ë“œ/ë¦¬ê·¸/ê·¸ë£¹/SUPER ê³„ì‚°
    function computeCardCodeFS(params) {
      const { priceMax, priceMin, volumeMax, volumeMin, amountMax, amountMin } = params || {};
      if ([priceMax, priceMin, volumeMax, volumeMin, amountMax, amountMin].some(v => v == null || isNaN(Number(v)))) {
        throw new Error('invalid params');
      }

      const toR = (max, min) => {
        const mx = Number(max);
        const mn = Number(min);
        if (mx === 0) return 0; // ë°©ì–´
        // ë³€ë™í­ ë¹„ìœ¨: (MAX - MIN) / MAX
        // MAXê°€ í¬ê³  MINì´ ì‘ì„ìˆ˜ë¡ rì´ í¼ (ë“±ê¸‰ ë†’ìŒ)
        // MINì´ MAXì— ê°€ê¹Œìš°ë©´ rì´ ì‘ìŒ (ë“±ê¸‰ ë‚®ìŒ)
        return (mx - mn) / mx;
      };

      const rPrice = toR(priceMax, priceMin);
      const rVol = toR(volumeMax, volumeMin);
      const rAmt = toR(amountMax, amountMin);

      const rToLetter = (r) => {
        if (r >= 0.80) return 'S';
        if (r >= 0.70) return 'A';
        if (r >= 0.60) return 'B';
        if (r >= 0.50) return 'C';
        if (r >= 0.40) return 'D';
        if (r >= 0.30) return 'E';
        return 'F';
      };

      const pL = rToLetter(rPrice);
      const vL = rToLetter(rVol);
      const aL = rToLetter(rAmt);

      const avgR = (rPrice + rVol + rAmt) / 3;
      const sign = avgR >= 0.65 ? '+' : (avgR <= 0.45 ? '-' : '');
      const code = `${pL}${vL}${aL}${sign}`;

      const letterPts = { F:0, E:1, D:2, C:3, B:4, A:5, S:6 };
      const avgPtsRaw = (letterPts[pL] + letterPts[vL] + letterPts[aL]) / 3;
      const avgPts = avgPtsRaw + (sign === '+' ? 0.25 : (sign === '-' ? -0.25 : 0));

      const league = (() => {
        if (avgPts < 2.0) return 'ë¸Œë¡ ì¦ˆ';
        if (avgPts < 3.0) return 'ì‹¤ë²„';
        if (avgPts < 4.0) return 'ê³¨ë“œ';
        if (avgPts < 5.0) return 'í”Œë˜í‹°ë„˜';
        if (avgPts < 5.75) return 'ë‹¤ì´ì•„';
        return 'ì²¼ë¦°ì €';
      })();

      const group = avgPts < 2.5 ? 'EASY' : (avgPts < 4.5 ? 'NORMAL' : 'HARD');

      const countAS = [pL, vL, aL].filter(ch => ch === 'A' || ch === 'S').length;
      const countS = [pL, vL, aL].filter(ch => ch === 'S').length;
      const isSuper = (countS >= 2) || (avgPts >= 5.5) || (sign === '+' && countAS >= 2);

      // ê°•í™”: r ê°’(0~1 ë²”ìœ„)ì˜ í‰ê· ì„ 1~99ê°•ìœ¼ë¡œ ë§¤í•‘
      // avgRì´ ë†’ì„ìˆ˜ë¡ (ë³€ë™í­ì´ í´ìˆ˜ë¡) ê°•í™” ìˆ˜ì¹˜ê°€ ë†’ì•„ì§
      // avgR: 0 â†’ 1ê°•, avgR: 1 â†’ 99ê°•
      const enhancement = Math.min(99, Math.max(1, Math.floor(avgR * 98) + 1));

      // ìƒ‰ìƒ: ê¸°í˜¸ì— ë§ì¶° ê°•ì¡°
      const color = sign === '+' ? '#00d1ff' : (sign === '-' ? '#ffb703' : '#e6eefc');

      return { code, league, group, super: isSuper, avgR, avgPts, color, enhancement };
    }

    // ML ë“±ê¸‰ ìš”ì²­
    function requestMlRating(cardPayload, onDone) {
      try {
        fetch('/api/ml/rating/predict', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ card: cardPayload })
        }).then(r => r.json()).then(res => {
          if (res && res.ok && typeof onDone === 'function') {
            onDone(res);
          }
        }).catch(() => {});
      } catch (_) {}
    }

    // ì¹´ë“œ ì½”ë“œ/ë¦¬ê·¸/ê·¸ë£¹/SUPER ê³„ì‚° ë° í‘œì‹œ (í˜„ì¬ ì¹´ë“œ ì „ìš© ë Œë”ëŸ¬)
    function calculateAndDisplayCardRating(params) {
      try {
        const res = computeCardCodeFS(params);
        const ratingDisplay = document.getElementById('ccRatingDisplay');
        const ratingScore = document.getElementById('ccRatingScore');
        const ratingSection = document.getElementById('ccRatingSection');
        if (ratingDisplay && ratingScore && ratingSection) {
          ratingDisplay.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span>`;
          ratingScore.innerHTML = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''}`;
          ratingSection.style.background = `linear-gradient(135deg, rgba(0,0,0,0.3), ${res.color}22)`;
          ratingSection.style.borderColor = `${res.color}44`;
        }
        window.ccCurrentRating = res;
        console.log('âœ… Card code computed:', res);

        // ML ë“±ê¸‰ ìš”ì²­ (í˜„ì¬ ì¹´ë“œ)
        if (window.ccCurrentData) {
          requestMlRating(window.ccCurrentData, (ml) => {
            window.ccCurrentRating.mlGrade = ml.grade;
            window.ccCurrentRating.mlEnhancement = ml.enhancement;
            if (ratingDisplay && ratingScore) {
              ratingDisplay.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span>`;
              ratingScore.innerHTML = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''} | ML ${ml.grade} +${ml.enhancement}ê°•`;
            }
          });
        }
      } catch (e) {
        console.warn('calculateAndDisplayCardRating failed:', e?.message);
      }
    }
    
    // ìš”ì•½ ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
    function drawSummaryChart(priceValues, volumeValues, turnoverValues) {
      const ctx = document.getElementById('ccSummaryChart');
      if (!ctx) return;
      
      // ìµœëŒ€ 15ê°œ í¬ì¸íŠ¸ë¡œ ê°„ë‹¨íˆ í‘œì‹œ
      const step = Math.max(1, Math.ceil(priceValues.length / 15));
      const labels = Array.from({length: Math.ceil(priceValues.length / step)}, (_, i) => '');
      const priceSample = priceValues.filter((_, i) => i % step === 0);
      const volumeSample = (volumeValues || []).filter((_, i) => i % step === 0);
      
      // ì •ê·œí™” (0~1 ë²”ìœ„)
      const normalize = (arr) => {
        if (!arr || arr.length === 0) return [];
        const vals = arr.filter(v => v != null);
        if (vals.length === 0) return arr.map(() => 0);
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        const range = max - min || 1;
        return arr.map(v => v == null ? 0 : (v - min) / range);
      };
      
      const normalizedPrice = normalize(priceSample);
      const normalizedVol = normalize(volumeSample);
      
      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      if (ccSummaryChart) {
        ccSummaryChart.destroy();
      }
      
      // ìƒˆ ì°¨íŠ¸ ìƒì„±
      ccSummaryChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'ê°€ê²©',
              data: normalizedPrice,
              borderColor: '#00d1ff',
              backgroundColor: 'rgba(0,209,255,0.15)',
              borderWidth: 2,
              fill: true,
              tension: 0.3,
              pointRadius: 1,
              pointHoverRadius: 2,
              pointBackgroundColor: '#00d1ff',
              yAxisID: 'y'
            },
            {
              label: 'ê±°ë˜ëŸ‰',
              data: normalizedVol,
              borderColor: '#0ecb81',
              backgroundColor: 'transparent',
              borderWidth: 1,
              fill: false,
              tension: 0.3,
              pointRadius: 0.5,
              pointBackgroundColor: '#0ecb81',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 300
          },
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              enabled: true,
              backgroundColor: 'rgba(0,0,0,0.8)',
              titleColor: '#ffffff',
              bodyColor: '#e6eefc',
              borderColor: 'rgba(255,255,255,0.2)',
              borderWidth: 1,
              padding: 6,
              displayColors: true,
              titleFont: { size: 10 },
              bodyFont: { size: 9 }
            }
          },
          scales: {
            y: {
              type: 'linear',
              display: false,
              position: 'left',
              min: 0,
              max: 1
            },
            y1: {
              type: 'linear',
              display: false,
              position: 'right',
              min: 0,
              max: 1
            },
            x: {
              display: false,
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // ë§¤ìˆ˜ ì¹´ë“œ ë¯¸ë‹ˆ ì°¨íŠ¸ (ê°œë³„ ìº”ë²„ìŠ¤)
    function drawBuyMiniChart(canvasId, priceValues, volumeValues) {
      const ctx = document.getElementById(canvasId);
      if (!ctx || !priceValues || priceValues.length === 0) return;

      const step = Math.max(1, Math.ceil(priceValues.length / 20));
      const labels = Array.from({length: Math.ceil(priceValues.length / step)}, () => '');
      const priceSample = priceValues.filter((_, i) => i % step === 0);
      const volumeSample = (volumeValues || []).filter((_, i) => i % step === 0);

      const normalize = (arr) => {
        if (!arr || arr.length === 0) return [];
        const vals = arr.filter(v => v != null);
        if (vals.length === 0) return arr.map(() => 0);
        const min = Math.min(...vals);
        const max = Math.max(...vals);
        const range = max - min || 1;
        return arr.map(v => v == null ? 0 : (v - min) / range);
      };

      const p = normalize(priceSample);
      const v = normalize(volumeSample);

      // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ê´€ë¦¬ ë° íŒŒê´´
      window._buyCharts = window._buyCharts || {};
      if (window._buyCharts[canvasId]) {
        try { window._buyCharts[canvasId].destroy(); } catch (_) {}
      }

      window._buyCharts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            { data: p, borderColor: '#00d1ff', backgroundColor: 'rgba(0,209,255,0.15)', borderWidth: 1.5, fill: true, tension: 0.3, pointRadius: 0 },
            { data: v, borderColor: '#0ecb81', backgroundColor: 'transparent', borderWidth: 1, fill: false, tension: 0.3, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: { x: { display: false }, y: { display: false } },
          animation: { duration: 200 }
        }
      });
    }
    
    // Debounce timer for preventing rapid updates (1ê°œì”©ë§Œ)
    let currentCardTimeout = null;
    
    function loadCurrentCardDebounced() {
      if (currentCardTimeout) clearTimeout(currentCardTimeout);
      currentCardTimeout = setTimeout(() => {
        loadCurrentCard();
        currentCardTimeout = null;
      }, 300); // 300ms debounce
    }
    
    // ì „ì—­ window ê°ì²´ì—ë„ í• ë‹¹
    window.loadCurrentCard = loadCurrentCard;
    window.loadCurrentCardDebounced = loadCurrentCardDebounced;
    
    // timeframe ë³€ê²½ ì‹œ í˜„ì¬ ì¹´ë“œ ì—…ë°ì´íŠ¸ (debounce ì ìš©)
    function onTimeframeChange() {
      console.log('ğŸ• Timeframe changed, updating current card...');
            // ìƒë‹¨ selectì˜ ê°’ìœ¼ë¡œ currentActiveTimeframe ì—…ë°ì´íŠ¸
            const sel = document.getElementById('timeframe');
            if (sel) {
              currentActiveTimeframe = sel.value;
              window.currentActiveTimeframe = sel.value;
            }
      loadCurrentCardDebounced();
    }
    window.onTimeframeChange = onTimeframeChange;

    // ê±°ë˜ ë¡œê·¸ ì¶”ê°€ í•¨ìˆ˜
    function addTradeLog(message, type = 'info') {
      const logList = document.getElementById('tradeLogList');
      if (!logList) return;
      
      // ì´ˆê¸° "ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
      const emptyMsg = logList.querySelector('.text-center.text-muted');
      if (emptyMsg) emptyMsg.remove();
      
      const logEntry = document.createElement('div');
      logEntry.style.cssText = 'padding: 8px; margin-bottom: 6px; border-radius: 4px; border-left: 3px solid;';
      
      const now = new Date().toLocaleTimeString('ko-KR');
      
      if (type === 'success') {
        logEntry.style.backgroundColor = 'rgba(14, 203, 129, 0.1)';
        logEntry.style.borderLeftColor = '#0ecb81';
        logEntry.innerHTML = `<div style="color: #0ecb81; font-weight: 600;">[${now}] âœ… ${message}</div>`;
      } else if (type === 'error') {
        logEntry.style.backgroundColor = 'rgba(246, 70, 93, 0.1)';
        logEntry.style.borderLeftColor = '#f6465d';
        logEntry.innerHTML = `<div style="color: #f6465d; font-weight: 600;">[${now}] âŒ ${message}</div>`;
      } else {
        logEntry.style.backgroundColor = 'rgba(230, 238, 252, 0.05)';
        logEntry.style.borderLeftColor = '#6c757d';
        logEntry.innerHTML = `<div style="color: #e6eefc;">[${now}] ${message}</div>`;
      }
      
      logList.insertBefore(logEntry, logList.firstChild);
      
      // ìµœëŒ€ 50ê°œ ë¡œê·¸ë§Œ ìœ ì§€
      while (logList.children.length > 50) {
        logList.removeChild(logList.lastChild);
      }
    }
    window.addTradeLog = addTradeLog;

    // ì´ˆê¸°í™” í•¨ìˆ˜ (ë™ì  ë¡œë“œì—ì„œë„ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡)
    function initCustomDashboard() {
      console.log('ğŸ¯ Initializing Custom Dashboard...');
      
      const refreshBtn = document.getElementById('ccRefresh');
      if (refreshBtn) refreshBtn.addEventListener('click', loadCurrentCard);
      
      const saveBtn = document.getElementById('ccSave');
      if (saveBtn) {
        saveBtn.addEventListener('click', async ()=>{
          try {
            const saveHint = document.getElementById('ccSaveHint');
            if (!window.ccCurrentData) {
              addTradeLog('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.', 'error');
              return;
            }
            
            saveHint.textContent = 'ì €ì¥ ì¤‘...';
            saveHint.style.color = '#4285f4';
            
            console.log('ğŸ’¾ NBverse ë°ì´í„° ì €ì¥:', window.ccCurrentData);
            
            // postJson í•¨ìˆ˜ë¡œ ì €ì¥
            if (typeof postJson === 'function') {
              const result = await postJson('/api/nbverse/save', window.ccCurrentData);
              if (result && result.ok) {
                saveHint.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
                saveHint.style.color = '#0ecb81';
                addTradeLog('í˜„ì¬ ì¹´ë“œ ë°ì´í„°ê°€ NBverseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                console.log('âœ… NBverse ì €ì¥ ì™„ë£Œ:', result);
              } else {
                saveHint.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                saveHint.style.color = '#f6465d';
                addTradeLog(`NBverse ì €ì¥ ì‹¤íŒ¨: ${result?.error || 'Unknown'}`, 'error');
              }
            } else {
              // postJsonì´ ì—†ìœ¼ë©´ fetch ì‚¬ìš©
              const response = await fetch('/api/nbverse/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(window.ccCurrentData)
              });
              const result = await response.json();
              if (result && result.ok) {
                saveHint.textContent = 'âœ… ì €ì¥ ì™„ë£Œ';
                saveHint.style.color = '#0ecb81';
                addTradeLog('í˜„ì¬ ì¹´ë“œ ë°ì´í„°ê°€ NBverseì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
              } else {
                saveHint.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                saveHint.style.color = '#f6465d';
                addTradeLog(`NBverse ì €ì¥ ì‹¤íŒ¨: ${result?.error || 'Unknown'}`, 'error');
              }
            }
          } catch (err) {
            console.error('NBverse ì €ì¥ ì—ëŸ¬:', err);
            document.getElementById('ccSaveHint').textContent = 'âŒ ì—ëŸ¬';
            document.getElementById('ccSaveHint').style.color = '#f6465d';
            addTradeLog(`NBverse ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'error');
          }
        });
      }
      
      const tradeLogRefreshBtn = document.getElementById('tradeLogRefresh');
      if (tradeLogRefreshBtn) {
        tradeLogRefreshBtn.addEventListener('click', ()=>{
          const logList = document.getElementById('tradeLogList');
          if (logList) {
            logList.innerHTML = '<div class="text-center text-muted py-2">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
            addTradeLog('ê±°ë˜ ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
          }
        });
      }
      
      const ccBuyBtn = document.getElementById('ccBuy');
      if (ccBuyBtn) {
        ccBuyBtn.addEventListener('click', async ()=>{
          try {
            const ccAmount = document.getElementById('ccBuyAmount');
            const buyAmount = ccAmount ? Number(ccAmount.value) : 5000;
            
            console.log('ğŸ›’ í˜„ì¬ ì¹´ë“œ ë§¤ìˆ˜ ì‹œì‘:', buyAmount, 'KRW');
            addTradeLog(`í˜„ì¬ ì¹´ë“œ ë§¤ìˆ˜ ì‹œì‘ (${buyAmount.toLocaleString()} KRW)`, 'info');
            
            // Use the same postJson function from ui.js
            if (typeof postJson !== 'function') {
              const errMsg = 'postJson í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ui.jsê°€ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.';
              addTradeLog(errMsg, 'error');
              console.error(errMsg);
              return;
            }
            
            // Call buy API with krw parameter (not amount)
            const payload = { krw: buyAmount, force: true };
            if (window.ccLastNbversePath) payload.nbverse_path = window.ccLastNbversePath;
            if (window.ccCurrentData && window.ccCurrentData.interval) payload.nbverse_interval = window.ccCurrentData.interval;
            if (window.ccCurrentData && window.ccCurrentData.timestamp) payload.nbverse_timestamp = window.ccCurrentData.timestamp;
            const result = await postJson('/api/trade/buy', payload);
            
            if (result && result.ok && result.order) {
              console.log('âœ… ë§¤ìˆ˜ ì„±ê³µ:', result.order);
              const price = Number(result.order.price||0).toLocaleString();
              const size = Number(result.order.size||0).toFixed(6);
              const paperMode = result.order.paper ? ' [PAPER]' : '';
              addTradeLog(`ë§¤ìˆ˜ ì™„ë£Œ! ê°€ê²©: ${price} KRW / ìˆ˜ëŸ‰: ${size}${paperMode}`, 'success');
              
              // ì¦‰ì‹œ UI ë°˜ì˜ì„ ìœ„í•´ ë¡œì»¬ ìºì‹œì— ì£¼ë¬¸ ì¶”ê°€ (ì„œë²„ /api/orders ëŒ€ê¸° ì—†ì´ í‘œì‹œ)
              try {
                const cached = JSON.parse(localStorage.getItem('cachedOrders') || '[]');
                const newOrder = {
                  ts: result.order.ts || Date.now(),
                  time: result.order.ts || Date.now(),
                  side: result.order.side || 'BUY',
                  price: Number(result.order.price || 0),
                  size: Number(result.order.size || 0),
                  paper: !!result.order.paper,
                  market: result.order.market || 'KRW-BTC',
                  // í˜„ì¬ ì¹´ë“œ ì „ì²´ ìŠ¤ëƒ…ìƒ·ì„ ì£¼ë¬¸ ê°ì²´ì— ì§ì ‘ í¬í•¨ (ëª¨ë“  N/B, ê·¸ë˜í”„, Zone í¬í•¨)
                  snapshot: window.ccCurrentData ? JSON.parse(JSON.stringify(window.ccCurrentData)) : null,
                  nbverse_path: result.order.nbverse_path || window.ccLastNbversePath || null
                };
                console.log('ğŸ’¾ ë§¤ìˆ˜ ì£¼ë¬¸ ì €ì¥:', newOrder);
                console.log('ğŸ“¸ ìŠ¤ëƒ…ìƒ· í¬í•¨ ì—¬ë¶€:', !!newOrder.snapshot);
                cached.unshift(newOrder);
                localStorage.setItem('cachedOrders', JSON.stringify(cached.slice(0, 200)));
                console.log('âœ… ìºì‹œ ì €ì¥ ì™„ë£Œ, ì´', cached.length, 'ê°œ ì£¼ë¬¸');

                // í˜„ì¬ ì¹´ë“œ ìŠ¤ëƒ…ìƒ·ì„ ì£¼ë¬¸ê³¼ ì—°ê²°í•´ ì €ì¥
                if (window.ccCurrentData) {
                  const snapKey = 'orderCardSnapshots';
                  let snaps = {};
                  try { snaps = JSON.parse(localStorage.getItem(snapKey) || '{}'); } catch(_) { snaps = {}; }
                  const key = String(newOrder.ts);
                  snaps[key] = window.ccCurrentData;
                  localStorage.setItem(snapKey, JSON.stringify(snaps));
                }
              } catch (_) {}
              
              // Refresh trade stats and balance
              if (typeof loadTradeStats === 'function') setTimeout(loadTradeStats, 500);
              if (typeof refreshAssets === 'function') setTimeout(refreshAssets, 1000);
            } else {
              const error = result?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
              const details = result?.current_nb_coins !== undefined 
                ? `(í˜„ì¬ ë³´ìœ : ${result.current_nb_coins}ê°œ, ìµœëŒ€: ${result.max_allowed}ê°œ)`
                : '';
              console.warn('âš ï¸ ë§¤ìˆ˜ ë¶ˆê°€:', error, details);
              addTradeLog(`ë§¤ìˆ˜ ë¶ˆê°€: ${error} ${details}`, 'error');
            }
          } catch (err) {
            console.error('ë§¤ìˆ˜ ì—ëŸ¬:', err);
            addTradeLog(`ë§¤ìˆ˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${err.message}`, 'error');
          }
        });
      }
      
      const sel = document.getElementById('timeframe');
      if (sel) {
        sel.addEventListener('change', onTimeframeChange);
      }
      // ì´ˆê¸° ë¡œë“œ
      // ì´ˆê¸° ë¶„ë´‰ ì„¤ì •
      if (sel && sel.value) {
        currentActiveTimeframe = sel.value;
        window.currentActiveTimeframe = sel.value;
      }
      loadCurrentCard();
      
      console.log('âœ… Custom Dashboard initialized');
    }
    
    // NBverse Zone Display ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (ui.jsì—ì„œ í˜¸ì¶œ)
    function updateCurrentZoneDisplay(zone) {
      const zoneEl = document.getElementById('ccNBZone');
      if (!zoneEl) return;
      
      const zoneLabel = zone === 'BLUE' ? 'ğŸ”µ BLUE' : zone === 'ORANGE' ? 'ğŸŸ  ORANGE' : 'âšª NONE';
      const zoneColor = zone === 'BLUE' ? '#00d1ff' : zone === 'ORANGE' ? '#ffb703' : '#888888';
      
      zoneEl.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 13px; font-weight: 700; color: ${zoneColor}; margin-bottom: 4px;">
            ${zoneLabel}
          </div>
        </div>
      `;
      console.log('âœ… Zone Display updated:', zone);
    }
    window.updateCurrentZoneDisplay = updateCurrentZoneDisplay;
    window.initCustomDashboard = initCustomDashboard;
    
    // Auto Buy Config module (encapsulated)
    const AutoBuyConfig = (() => {
      const els = {};
      let isRunning = false;
      const STORAGE_KEY = 'autoBuyState';
      
      function cache() {
        els.interval = document.getElementById('abInterval');
        els.startBtn = document.getElementById('abStartBtn');
        els.stopBtn = document.getElementById('abStopBtn');
      }
      
      function saveState() {
        try {
          const state = {
            isRunning,
            interval: els.interval?.value || '',
            timestamp: Date.now()
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        } catch (e) {
          console.error('Failed to save auto-buy state', e);
        }
      }
      
      function loadState() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const state = JSON.parse(saved);
            // 5ë¶„ ì´ë‚´ì˜ ìƒíƒœë§Œ ë³µì›
            if (Date.now() - state.timestamp < 300000) {
              return state;
            }
          }
        } catch (e) {
          console.error('Failed to load auto-buy state', e);
        }
        return null;
      }
      
      async function load() {
        try {
          const res = await fetch('/api/auto-buy/config');
          const data = await res.json();
          const cfg = data.config || data; // API returns { ok, config }
          const intervals = cfg.intervals || [];
          
          // ì„œë²„ ìƒíƒœ ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬ ìƒíƒœ ë³µì›
          isRunning = !!cfg.enabled;
          
          if (els.interval) {
            if (intervals.length > 0) {
              els.interval.value = intervals[0];
            } else {
              // ë¡œì»¬ ìƒíƒœ ë³µì› ì‹œë„
              const savedState = loadState();
              if (savedState && savedState.interval) {
                els.interval.value = savedState.interval;
              }
            }
          }
          
          console.log('âœ… Auto-buy config loaded:', { enabled: cfg.enabled, intervals, isRunning });
          updateButtonStates();
          saveState();
        } catch (e) {
          console.error('Failed to load auto-buy config', e);
          // API ì‹¤íŒ¨ ì‹œ ë¡œì»¬ ìƒíƒœ ë³µì›
          const savedState = loadState();
          if (savedState) {
            if (els.interval) els.interval.value = savedState.interval;
            isRunning = savedState.isRunning;
            updateButtonStates();
          }
        }
      }
      
      async function start() {
        try {
          const interval = els.interval?.value;
          
          if (!interval) {
            alert('ì²´í¬ ê°„ê²©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
          }
          
          const body = { enabled: true, cooldown_sec: 0, intervals: [interval] };
          console.log('ğŸš€ Starting auto-buy:', body);
          const res = await fetch('/api/auto-buy/config', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
          });
          if (!res.ok) throw new Error('Bad status ' + res.status);
          const j = await res.json();
          console.log('âœ… Auto-buy started:', j);
          isRunning = true;
          saveState();
          updateButtonStates();
          // ì¦‰ì‹œ ìƒíƒœ ê°±ì‹ 
          AutoBuyStatus.refresh();
        } catch (e) {
          console.error('Failed to start auto-buy', e);
          alert('ìë™ ë§¤ìˆ˜ ì‹œì‘ ì‹¤íŒ¨: ' + e.message);
        }
      }
      
      async function stop() {
        try {
          const interval = els.interval?.value || '';
          const body = { enabled: false, cooldown_sec: 0, intervals: interval ? [interval] : [] };
          console.log('ğŸ›‘ Stopping auto-buy:', body);
          const res = await fetch('/api/auto-buy/config', {
            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
          });
          if (!res.ok) throw new Error('Bad status ' + res.status);
          const j = await res.json();
          console.log('âœ… Auto-buy stopped:', j);
          isRunning = false;
          saveState();
          updateButtonStates();
          // ì¦‰ì‹œ ìƒíƒœ ê°±ì‹ 
          AutoBuyStatus.refresh();
        } catch (e) {
          console.error('Failed to stop auto-buy', e);
          alert('ìë™ ë§¤ìˆ˜ ì¤‘ì§€ ì‹¤íŒ¨: ' + e.message);
        }
      }
      
      function updateButtonStates() {
        if (els.startBtn) {
          els.startBtn.disabled = isRunning;
          els.startBtn.style.opacity = isRunning ? '0.5' : '1';
          els.startBtn.style.cursor = isRunning ? 'not-allowed' : 'pointer';
        }
        if (els.stopBtn) {
          els.stopBtn.disabled = !isRunning;
          els.stopBtn.style.opacity = !isRunning ? '0.5' : '1';
          els.stopBtn.style.cursor = !isRunning ? 'not-allowed' : 'pointer';
        }
        if (els.interval) {
          els.interval.disabled = isRunning;
        }
      }
      
      function bind() {
        if (els.startBtn) els.startBtn.addEventListener('click', start);
        if (els.stopBtn) els.stopBtn.addEventListener('click', stop);
      }
      
      function init() { cache(); bind(); load(); }
      return { init, load, start, stop };
    })();
    
    // Auto Buy Status module (polls server for heartbeat and cooldowns)
    const AutoBuyStatus = (() => {
      let timer = null;
      let localTimer = null;
      let serverSyncTime = 0; // ì„œë²„ì™€ ë™ê¸°í™”ëœ ê¸°ì¤€ ì‹œê°„
      let clientSyncTime = 0; // í´ë¼ì´ì–¸íŠ¸ ê¸°ì¤€ ì‹œê°„
      let intervalSeconds = 60;
      let isEnabled = false;
      
      const el = {
        bar: null, status: null, next: null, progressText: null
      };
      const ivLabel = (iv) => ({
        minute1:'1ë¶„', minute3:'3ë¶„', minute5:'5ë¶„', minute10:'10ë¶„', minute15:'15ë¶„', minute30:'30ë¶„', minute60:'1ì‹œê°„', minute120:'2ì‹œê°„', minute240:'4ì‹œê°„', minute360:'6ì‹œê°„', minute480:'8ì‹œê°„', day:'1ì¼'
      })[iv] || iv;
      
      const ivToSeconds = (iv) => {
        const match = iv.match(/minute(\d+)/);
        if (match) return parseInt(match[1]) * 60;
        if (iv === 'day') return 1440 * 60;
        return 60;
      };
      
      function cache() {
        el.bar = document.getElementById('abProgressBar');
        el.status = document.getElementById('abStatusText');
        el.next = document.getElementById('abNextText');
        el.progressText = document.getElementById('abProgressText');
      }
      
      function setBar(pct, text) {
        if (el.bar) el.bar.style.width = Math.max(0, Math.min(100, pct)) + '%';
        if (el.progressText) el.progressText.textContent = text || '';
      }
      
      function updateLocalTimer() {
        if (!isEnabled || serverSyncTime === 0) {
          setBar(0, '-');
          return;
        }
        
        // ì„œë²„ ë™ê¸°í™” ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ê²½ê³¼ ì‹œê°„ ê³„ì‚°
        const clientNow = Date.now();
        const elapsedMs = clientNow - clientSyncTime;
        const serverNow = serverSyncTime + Math.floor(elapsedMs / 1000);
        
        const lastPoll = serverNow - (serverNow % intervalSeconds);
        const nextPoll = lastPoll + intervalSeconds;
        const remaining = Math.max(0, nextPoll - serverNow);
        const elapsed = intervalSeconds - remaining;
        const pct = (elapsed / intervalSeconds) * 100;
        
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const timeText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
        
        setBar(pct, timeText);
      }
      
      async function tick() {
        try {
          const res = await fetch('/api/auto-buy/status');
          const s = await res.json();
          isEnabled = !!s.enabled;
          const serverTime = Number(s.server_time || 0);
          const lastPoll = Number(s.last_poll_ts || 0);
          const ivs = Array.isArray(s.intervals) ? s.intervals : [];
          
          // ì„œë²„ ì‹œê°„ ë™ê¸°í™”
          serverSyncTime = serverTime;
          clientSyncTime = Date.now();
          
          if (ivs.length > 0) {
            intervalSeconds = ivToSeconds(ivs[0]);
          }
          
          const elapsed = Math.max(0, serverTime - lastPoll);
          const remain = Math.max(0, intervalSeconds - elapsed);
          const pct = Math.min(100, Math.max(0, (elapsed / intervalSeconds) * 100));
          
          if (el.status) {
            el.status.textContent = isEnabled ? 'â–¶ ì‹¤í–‰ ì¤‘' : 'â¸ ì¤‘ì§€ë¨';
            el.status.style.color = isEnabled ? '#00d1ff' : '#9aa8c2';
          }
          
          if (isEnabled && ivs.length > 0) {
            const minutes = Math.floor(remain / 60);
            const seconds = remain % 60;
            const timeText = minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            setBar(pct, timeText);
            if (el.next) el.next.textContent = `${ivLabel(ivs[0])} ê°„ê²©`;
          } else {
            serverSyncTime = 0;
            clientSyncTime = 0;
            intervalSeconds = 60;
            setBar(0, '-');
            if (el.next) el.next.textContent = '-';
          }
        } catch (e) {
          console.error('Failed to fetch auto-buy status', e);
          serverSyncTime = 0;
          clientSyncTime = 0;
          isEnabled = false;
          setBar(0, '-');
          if (el.status) {
            el.status.textContent = 'âš  ì˜¤ë¥˜';
            el.status.style.color = '#ff4757';
          }
          if (el.next) el.next.textContent = '-';
        }
      }
      
      function stop() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        if (localTimer) {
          clearInterval(localTimer);
          localTimer = null;
        }
      }
      
      function start() {
        stop(); // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
        
        timer = setInterval(tick, 3000); // 3ì´ˆë§ˆë‹¤ ì„œë²„ ë™ê¸°í™”
        localTimer = setInterval(updateLocalTimer, 500); // 0.5ì´ˆë§ˆë‹¤ UI ì—…ë°ì´íŠ¸
        tick(); // ì¦‰ì‹œ ì‹¤í–‰
      }
      
      function refresh() {
        tick(); // ì¦‰ì‹œ ìƒíƒœ ê°±ì‹ 
      }
      
      function init() { 
        cache(); 
        start(); 
      }
      
      return { init, refresh, stop };
    })();
    
    document.addEventListener('DOMContentLoaded', () => { AutoBuyConfig.init(); AutoBuyStatus.init(); });
    
    // DOMContentLoaded ë˜ëŠ” ì¦‰ì‹œ ì‹¤í–‰
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCustomDashboard);
    } else {
      // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      setTimeout(initCustomDashboard, 100);
    }
    
    // ê±°ë˜ í†µê³„ ë¡œë”
    async function loadTradeStats() {
      try {
        const now = new Date().toLocaleTimeString('ko-KR');
        document.getElementById('buyStatsTime').textContent = now;
        document.getElementById('sellStatsTime').textContent = now;
        
        // íŒŒì¼ì—ì„œ ë§¤ìˆ˜/ë§¤ë„ ì¹´ë“œ ë¡œë“œ
        let buyOrders = [];
        let sellOrders = [];
        
        try {
          const buyRes = await fetch('/api/cards/buy');
          const buyData = await buyRes.json();
          if (buyData && buyData.ok) {
            buyOrders = buyData.cards || [];
          }
        } catch (e) {
          console.error('Failed to load buy cards:', e);
          // ìºì‹œì—ì„œ ë³µì›
          try {
            const cachedBuyOrders = localStorage.getItem('buyOrdersCache');
            if (cachedBuyOrders) {
              buyOrders = JSON.parse(cachedBuyOrders);
              console.log('ğŸ’¾ ìºì‹œì—ì„œ ë§¤ìˆ˜ ì¹´ë“œ ë³µì›:', buyOrders.length, 'ê°œ');
            }
          } catch (_) {}
        }
        
        try {
          const sellRes = await fetch('/api/cards/sell');
          const sellData = await sellRes.json();
          if (sellData && sellData.ok) {
            sellOrders = sellData.cards || [];
          }
        } catch (e) {
          console.error('Failed to load sell cards:', e);
        }

        // ìë™ ML í•™ìŠµ íŠ¸ë¦¬ê±° (ì„œë²„ê°€ sell ì¹´ë“œë¡œ í•™ìŠµ)
        try {
          fetch('/api/ml/rating/train', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ auto: true }) 
          })
            .then(async r => {
              // ëª¨ë“  ìƒíƒœë¥¼ ì •ìƒìœ¼ë¡œ ì²˜ë¦¬ (400ì€ í•™ìŠµ ë°ì´í„° ë¶€ì¡±, ì •ìƒ)
              if (r.status === 400) {
                console.log('ğŸ¤– ML í•™ìŠµ ëŒ€ê¸° ì¤‘ (í•™ìŠµ ë°ì´í„° ìˆ˜ì§‘ ì¤‘...)');
                return null;
              }
              if (!r.ok) {
                console.log('ğŸ¤– ML í•™ìŠµ ì‘ë‹µ:', `ìƒíƒœ ${r.status}`);
                return null;
              }
              return r.json();
            })
            .then(r => {
              if (r && r.ok) {
                console.log('ğŸ¤– ML í•™ìŠµ ì™„ë£Œ:', r);
              }
            })
            .catch(e => {
              // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë§Œ ë¡œê·¸ (ìƒíƒœ ì˜¤ë¥˜ëŠ” ìœ„ì—ì„œ ì²˜ë¦¬ë¨)
              console.debug('ğŸ¤– ML í•™ìŠµ ìš”ì²­ ìƒíƒœ:', e.message);
            });
        } catch(_) {}
        
        console.log('ğŸ“Š loadTradeStats: ì´', buyOrders.length + sellOrders.length, 'ê°œ ì¹´ë“œ, ë§¤ìˆ˜', buyOrders.length, 'ê°œ, ë§¤ë„', sellOrders.length, 'ê°œ');

        // íŒë§¤ ì‹¤í˜„ ì†ìµ ê³„ì‚° (FIFO ë§¤ì¹­)
        const sortedBuys = [...buyOrders].sort((a, b) => Number(a.time || a.ts || 0) - Number(b.time || b.ts || 0));
        const sortedSells = [...sellOrders].sort((a, b) => Number(a.time || a.ts || 0) - Number(b.time || b.ts || 0));
        const buyQueue = sortedBuys.map(o => ({
          size: Number(o.size || 0),
          price: Number(o.price || 0)
        }));
        let realizedTotal = 0;
        let realizedMax = 0;
        let realizedCount = 0;
        sortedSells.forEach(sell => {
          let remain = Number(sell.size || 0);
          const sellPrice = Number(sell.price || 0);
          let sellProfit = 0;
          while (remain > 0 && buyQueue.length > 0) {
            const buy = buyQueue[0];
            const qty = Math.min(remain, buy.size);
            sellProfit += (sellPrice - buy.price) * qty;
            buy.size -= qty;
            remain -= qty;
            if (buy.size <= 0.00000001) buyQueue.shift();
          }
          // ë‚¨ì€ ìˆ˜ëŸ‰(ì´ˆê³¼ ë§¤ë„)ì€ ì›ê°€ 0ìœ¼ë¡œ ì²˜ë¦¬
          if (remain > 0) {
            sellProfit += (sellPrice * remain);
            remain = 0;
          }
          realizedTotal += sellProfit;
          realizedMax = Math.max(realizedMax, sellProfit);
          realizedCount += 1;
        });
        const realizedAvg = realizedCount > 0 ? (realizedTotal / realizedCount) : 0;

        // ì „ì²´ ì£¼ë¬¸ ëª¨ìŒ (ë¡œê·¸/ê°€ê²© ì°¸ê³ )
        const allOrders = [...buyOrders, ...sellOrders];

        // ë§¤ìˆ˜/ë§¤ë„ ë¡œê·¸ (ìµœì‹ ìˆœ)
        const logEl = document.getElementById('tradeLogList');
        if (logEl) {
          const ordered = allOrders.sort((a, b) => (Number(b.time || b.ts || 0) - Number(a.time || a.ts || 0)));
          if (ordered.length > 0) {
            logEl.innerHTML = ordered.slice(0, 30).map(o => {
              const isBuy = (o.side === 'bid' || o.side === 'BUY');
              const price = Number(o.price || 0).toLocaleString();
              const size = Number(o.size || 0).toFixed(6);
              const time = o.time ? new Date(o.time).toLocaleTimeString('ko-KR') : (o.ts ? new Date(o.ts).toLocaleTimeString('ko-KR') : '-');
              const paper = o.paper ? '[PAPER]' : '';
              const sideBadge = isBuy ? '<span style="color:#0ecb81; font-weight:700;">BUY</span>' : '<span style="color:#f6465d; font-weight:700;">SELL</span>';
              return `<div style="padding:6px 0; border-bottom:1px solid rgba(255,255,255,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div>${sideBadge} <span style="color:#9aa8c2;">${time}</span></div>
                  <div style="color:${isBuy ? '#0ecb81' : '#f6465d'}; font-weight:600;">${price} KRW</div>
                </div>
                <div style="display:flex; justify-content:space-between; font-size:11px; color:#9aa8c2;">
                  <span>${size} ${o.market || 'BTC'} ${paper}</span>
                  <span>${(Number(o.price || 0) * Number(o.size || 0)).toFixed(0).toLocaleString()} KRW</span>
                </div>
              </div>`;
            }).join('');
          } else {
            logEl.innerHTML = '<div class="text-center text-muted py-2">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
          }
        }
        
        // ë§¤ìˆ˜ í†µê³„
        document.getElementById('buyCount').textContent = buyOrders.length;
        const buyTotal = buyOrders.reduce((sum, o) => sum + (Number(o.price || 0) * Number(o.size || 0)), 0);
        const buyAvg = buyOrders.length > 0 ? buyTotal / buyOrders.length : 0;

        // ë§¤ë„ í†µê³„(ì„  ê³„ì‚°: ì†ìµ ê³„ì‚°ì—ì„œë„ í™œìš©)
        const sellTotal = sellOrders.reduce((sum, o) => sum + (Number(o.price || 0) * Number(o.size || 0)), 0);
        const sellAvg = sellOrders.length > 0 ? sellTotal / sellOrders.length : 0;

        // í˜„ì¬ê°€ ì¶”ì¶œ (ìº”ë“¤ ìºì‹œ â†’ ìµœê·¼ ì£¼ë¬¸ ê°€ê²© ìˆœ)
        let lastPrice = 0;
        try {
          const lastCandle = (window.candleDataCache || []).slice(-1)[0];
          lastPrice = Number(lastCandle?.close || lastCandle?.value || 0) || 0;
        } catch (_) { lastPrice = 0; }
        if (!lastPrice && allOrders.length > 0) {
          lastPrice = Number(allOrders[0].price || 0) || 0;
        }

        // ë³´ìœ  ìˆ˜ëŸ‰/ì”ì¡´ ì›ê°€/í˜„ì¬ ì†ìµ ê³„ì‚° (ë‹¨ìˆœ ê³„ì‚°: ë§¤ìˆ˜ ì›ê°€ - ë§¤ë„ ê¸ˆì•¡ì„ ì”ì¡´ ì›ê°€ë¡œ ê°„ì£¼)
        const buySizeTotal = buyOrders.reduce((sum, o) => sum + Number(o.size || 0), 0);
        const sellSizeTotal = sellOrders.reduce((sum, o) => sum + Number(o.size || 0), 0);
        const netSize = buySizeTotal - sellSizeTotal;
        const remainingCost = Math.max(0, buyTotal - sellTotal);
        const currentValue = netSize > 0 ? (lastPrice * netSize) : 0;
        
        // ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ë§¤ìˆ˜: 0.1%, ë§¤ë„: 0.1%)
        const buyFee = buyTotal * 0.001; // ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ
        const sellFee = sellTotal * 0.001; // ë§¤ë„ ìˆ˜ìˆ˜ë£Œ
        const totalFees = buyFee + sellFee;
        
        // ë¯¸ì‹¤í˜„ ì†ìµ = í˜„ì¬ ì‹œê°€ - (ë§¤ìˆ˜ ì›ê°€ + ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ) - ë¯¸ì‹¤í˜„ ìˆ˜ìˆ˜ë£Œ
        const unrealizedFeeAdjustment = netSize > 0 ? (currentValue * 0.001) : 0; // ë§¤ë„ ì‹œ ì˜ˆìƒ ìˆ˜ìˆ˜ë£Œ
        const unrealized = currentValue - remainingCost - buyFee - unrealizedFeeAdjustment;
        const unrealizedRate = remainingCost > 0 ? (unrealized / remainingCost) * 100 : 0;

        // í˜„ì¬ ì¹´ë“œì— ì‹¤í˜„ ì†ìµ ë°˜ì˜
        const ccRealizedAvgEl = document.getElementById('ccRealizedAvg');
        const ccRealizedMaxEl = document.getElementById('ccRealizedMax');
        if (ccRealizedAvgEl) {
          ccRealizedAvgEl.textContent = Math.round(realizedAvg).toLocaleString() + ' KRW';
          ccRealizedAvgEl.style.color = realizedAvg >= 0 ? '#0ecb81' : '#f6465d';
        }
        if (ccRealizedMaxEl) {
          ccRealizedMaxEl.textContent = Math.round(realizedMax).toLocaleString() + ' KRW';
          ccRealizedMaxEl.style.color = realizedMax >= 0 ? '#0ecb81' : '#f6465d';
        }
        
        // ë§¤ìˆ˜ ë‚´ì—­ ìºì‹œ ì €ì¥
        try {
          localStorage.setItem('buyOrdersCache', JSON.stringify(buyOrders));
          localStorage.setItem('buyOrdersCacheTime', String(Date.now()));
          console.log('ğŸ’¾ ë§¤ìˆ˜ ì¹´ë“œ ìºì‹œ ì €ì¥:', buyOrders.length, 'ê°œ');
        } catch (_) {}
        
        // ë§¤ìˆ˜ ë‚´ì—­ ëª©ë¡
        const buyListEl = document.getElementById('buyOrderList');
        if (buyOrders.length > 0) {
          console.log('ğŸ›’ ë§¤ìˆ˜ ëª©ë¡ ë Œë”ë§ ì‹œì‘:', buyOrders.length, 'ê°œ');
          
          buyListEl.innerHTML = buyOrders.slice(0, 50).map((o, idx) => {
            const price = Number(o.price || 0);
            const size = Number(o.size || 0);
            const time = o.time ? new Date(o.time).toLocaleString('ko-KR') : (o.ts ? new Date(o.ts).toLocaleString('ko-KR') : '-');
            const paper = o.paper ? '[PAPER]' : '';
            const totalKrw = (price * size).toFixed(0);
            
            // insight ì •ë³´
            const ins = o.insight || {};
            const zone = ins.zone || '-';
            const zoneColor = zone === 'BLUE' ? '#00d1ff' : zone === 'ORANGE' ? '#ffb703' : '#888';
            const zoneBg = zone === 'BLUE' ? 'rgba(0,209,255,0.3)' : zone === 'ORANGE' ? 'rgba(255,183,3,0.3)' : 'rgba(136,136,136,0.3)';
            
            const r = typeof ins.r === 'number' ? ins.r.toFixed(2) : '-';
            const w = typeof ins.w === 'number' ? ins.w.toFixed(6) : '-';
            const pctBlue = typeof ins.pct_blue === 'number' ? ins.pct_blue.toFixed(1) : '-';
            const pctOrange = typeof ins.pct_orange === 'number' ? ins.pct_orange.toFixed(1) : '-';
            const distHigh = typeof ins.dist_high === 'number' ? ins.dist_high.toFixed(2) : '-';
            const distLow = typeof ins.dist_low === 'number' ? ins.dist_low.toFixed(2) : '-';
            const emaDiff = typeof ins.ema_diff === 'number' ? ins.ema_diff.toFixed(0) : '-';
            const extremeGap = typeof ins.extreme_gap === 'number' ? ins.extreme_gap.toFixed(2) : '-';
            const zoneConf = typeof ins.zone_conf === 'number' ? ins.zone_conf.toFixed(2) : '-';
            const zoneFlag = ins.zone_flag || 0;
            const zoneExtremeAge = ins.zone_extreme_age || '-';
            const zoneExtremePrice = typeof ins.zone_extreme_price === 'number' ? Math.round(ins.zone_extreme_price).toLocaleString() : '-';
            const zoneExtremeR = typeof ins.zone_extreme_r === 'number' ? ins.zone_extreme_r.toFixed(2) : '-';
            const zoneMaxPrice = typeof ins.zone_max_price === 'number' ? Math.round(ins.zone_max_price).toLocaleString() : '-';
            const zoneMaxR = typeof ins.zone_max_r === 'number' ? ins.zone_max_r.toFixed(2) : '-';
            const zoneMinPrice = typeof ins.zone_min_price === 'number' ? Math.round(ins.zone_min_price).toLocaleString() : '-';
            const zoneMinR = typeof ins.zone_min_r === 'number' ? ins.zone_min_r.toFixed(2) : '-';
            
            const chartId = `buyChart_${o.ts || idx}`;
            const tfi = (window.currentActiveTimeframe || 'minute10');
            const tfMap = {minute1:'1m', minute3:'3m', minute5:'5m', minute10:'10m', minute15:'15m', minute30:'30m', minute60:'1h', day:'1D'};
            const tfLabel = tfMap[tfi] || tfi;
            return `<div id="buyCard_${o.ts || idx}" data-buy-ts="${o.ts || ''}" data-market="${o.market || 'KRW-BTC'}" data-price="${o.price || 0}" data-size="${o.size || 0}" data-nbverse-path="${o.nbverse_path || ''}" style="background: linear-gradient(135deg, rgba(30,35,41,0.95), rgba(14,20,36,0.95)); border: 1px solid ${zoneBg}; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
              <!-- í—¤ë” -->
              <div style="border-bottom: 2px solid ${zoneBg}; padding-bottom: 10px; margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <strong style="color: #ffffff; font-size: 15px;">ğŸ›’ ë§¤ìˆ˜ #${idx + 1}</strong>
                    <span style="background:#00d1ff; color:#0b1220; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">${tfLabel}</span>
                  </div>
                  <span style="background: ${zoneColor}; color: #0b1220; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700;">${zone}</span>
                </div>
                <div style="font-size: 10px; color: #888; margin-top: 6px;">${time}</div>
                ${paper ? '<div style="color:#ffb703; font-size:10px; margin-top:4px;">ğŸ“„ PAPER MODE</div>' : ''}
              </div>

              <!-- ì¹´ë“œ ì½”ë“œ / ë¦¬ê·¸ -->
              <div style="display:flex; justify-content:space-between; align-items:center; margin: -4px 0 10px 0;">
                <div style="font-size:11px; color:#9aa8c2;">ì¹´ë“œ ì½”ë“œ</div>
                <div id="${chartId}_ratingCode" style="font-size:14px; font-weight:700;">-</div>
              </div>
              <div id="${chartId}_ratingMeta" style="font-size:11px; color:#9aa8c2; margin-top:-6px; margin-bottom:10px;">-</div>
              
              <!-- ë§¤ìˆ˜ ê°€ê²© (ê°•ì¡°) -->
              <div style="background: rgba(14,203,129,0.1); border-radius: 8px; padding: 12px; margin-bottom: 12px; border: 1px solid rgba(14,203,129,0.3);">
                <div style="font-size: 10px; color: #888; margin-bottom: 4px;">ë§¤ìˆ˜ ê°€ê²©</div>
                <div style="font-size: 20px; font-weight: 700; color: #0ecb81;">${price.toLocaleString()}</div>
              </div>
              
              <!-- ìˆ˜ëŸ‰ & ì´ì•¡ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                <div style="background: rgba(14,203,129,0.1); border-radius: 8px; padding: 10px; border: 1px solid rgba(14,203,129,0.3);">
                  <div style="font-size: 9px; color: #888; margin-bottom: 4px;">ë§¤ìˆ˜ ìˆ˜ëŸ‰</div>
                  <div style="font-size: 13px; font-weight: 700; color: #0ecb81;">${size.toFixed(8)}</div>
                </div>
                <div style="background: rgba(66,133,244,0.1); border-radius: 8px; padding: 10px; border: 1px solid rgba(66,133,244,0.3);">
                  <div style="font-size: 9px; color: #888; margin-bottom: 4px;">ì´ ê¸ˆì•¡</div>
                  <div style="font-size: 13px; font-weight: 700; color: #4285f4;">${Number(totalKrw).toLocaleString()}</div>
                </div>
              </div>
              
              <!-- Zone ìƒì„¸ ì •ë³´ -->
              <div style="margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ—ºï¸ Zone ìƒì„¸</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 10px;">
                    <div>
                      <span style="color: #888;">R: </span>
                      <span style="color: #0ecb81; font-weight: 600;">${r}</span>
                    </div>
                    <div>
                      <span style="color: #888;">W: </span>
                      <span style="color: #00d1ff; font-weight: 600;">${w}</span>
                    </div>
                    <div>
                      <span style="color: #888;">Blue%: </span>
                      <span style="color: #00d1ff; font-weight: 600;">${pctBlue}%</span>
                    </div>
                    <div>
                      <span style="color: #888;">Orange%: </span>
                      <span style="color: #ffb703; font-weight: 600;">${pctOrange}%</span>
                    </div>
                    <div>
                      <span style="color: #888;">Dist High: </span>
                      <span style="color: #f6465d; font-weight: 600;">${distHigh}</span>
                    </div>
                    <div>
                      <span style="color: #888;">Dist Low: </span>
                      <span style="color: #0ecb81; font-weight: 600;">${distLow}</span>
                    </div>
                    <div>
                      <span style="color: #888;">EMA Diff: </span>
                      <span style="color: #9c27b0; font-weight: 600;">${emaDiff}</span>
                    </div>
                    <div>
                      <span style="color: #888;">Conf: </span>
                      <span style="color: #4285f4; font-weight: 600;">${zoneConf}</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Zone ê·¹ê°’ ì •ë³´ -->
              <div style="margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“Š Zone ê·¹ê°’</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="margin-bottom: 6px;">
                    <div style="font-size: 9px; color: #888; margin-bottom: 2px;">Extreme (Age: ${zoneExtremeAge})</div>
                    <div style="font-size: 10px;">
                      <span style="color: #fff; font-weight: 600;">${zoneExtremePrice}</span>
                      <span style="color: #888;"> (R: </span>
                      <span style="color: #0ecb81; font-weight: 600;">${zoneExtremeR}</span>
                      <span style="color: #888;">)</span>
                    </div>
                  </div>
                  <div style="margin-bottom: 6px;">
                    <div style="font-size: 9px; color: #888; margin-bottom: 2px;">MAX</div>
                    <div style="font-size: 10px;">
                      <span style="color: #fff; font-weight: 600;">${zoneMaxPrice}</span>
                      <span style="color: #888;"> (R: </span>
                      <span style="color: #0ecb81; font-weight: 600;">${zoneMaxR}</span>
                      <span style="color: #888;">)</span>
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 9px; color: #888; margin-bottom: 2px;">MIN</div>
                    <div style="font-size: 10px;">
                      <span style="color: #fff; font-weight: 600;">${zoneMinPrice}</span>
                      <span style="color: #888;"> (R: </span>
                      <span style="color: #f6465d; font-weight: 600;">${zoneMinR}</span>
                      <span style="color: #888;">)</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- ì¶”ê°€ ì§€í‘œ -->
              <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; font-size: 10px;">
                  <div>
                    <span style="color: #888;">Extreme Gap: </span>
                    <span style="color: #ffb703; font-weight: 600;">${extremeGap}</span>
                  </div>
                  <div>
                    <span style="color: #888;">Flag: </span>
                    <span style="color: ${zoneFlag > 0 ? '#0ecb81' : zoneFlag < 0 ? '#f6465d' : '#888'}; font-weight: 600;">${zoneFlag}</span>
                  </div>
                </div>
              </div>
              
              <!-- í˜„ì¬ ì‹œì„¸ & ë¯¸ì‹¤í˜„ ì†ìµ -->
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 12px 0;">
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border:1px solid rgba(255,255,255,0.08);">
                  <div style="font-size:10px; color:#888;">í˜„ì¬ ì‹œì„¸</div>
                  <div id="${chartId}_cpnow" style="font-size:13px; font-weight:700; color:#00d1ff;">-</div>
                </div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border:1px solid rgba(255,255,255,0.08);">
                  <div style="font-size:10px; color:#888;">ë¯¸ì‹¤í˜„ ì†ìµ (ìˆ˜ìˆ˜ë£Œ 0.1% í¬í•¨)</div>
                  <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div id="${chartId}_pnl" style="font-size:13px; font-weight:700;">-</div>
                    <div id="${chartId}_pnlRate" style="font-size:11px;">-</div>
                  </div>
                </div>
              </div>
              
              <!-- ìˆ˜ìˆ˜ë£Œ ì •ë³´ -->
              <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px;">
                <div style="font-size:10px; color:#888; margin-bottom: 4px;">ğŸ’¸ ìˆ˜ìˆ˜ë£Œ ì •ë³´</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size:11px;">
                  <div class="d-flex justify-content-between">
                    <span style="color:#888;">ë§¤ìˆ˜ ìˆ˜ìˆ˜ë£Œ:</span>
                    <span style="color:#f6465d;" id="${chartId}_buyFee">-</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span style="color:#888;">ë§¤ë„ ìˆ˜ìˆ˜ë£Œ:</span>
                    <span style="color:#f6465d;" id="${chartId}_sellFee">-</span>
                  </div>
                </div>
              </div>

              <!-- ì•¡ì…˜ -->
              <div style="display:flex; gap:8px; margin: 4px 0 12px 0;">
                <button id="${chartId}_sellBtn" style="flex:1; background:#f6465d; color:#0b1220; border: none; border-radius: 6px; padding: 8px 10px; font-weight:700; font-size:12px; cursor:pointer;">ì‹œì¥ê°€ ë§¤ë„</button>
              </div>

              <!-- N/B ê°’ë“¤ -->
              <div style="margin-bottom: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’° ê°€ê²© N/B</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_pmax" style="font-size:11px; font-weight:600; color:#0ecb81;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_pmin" style="font-size:11px; font-weight:600; color:#f6465d;">-</span></div>
                </div>
              </div>
              <div style="margin-bottom: 8px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“ˆ ê±°ë˜ëŸ‰ N/B</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_vmax" style="font-size:11px; font-weight:600; color:#2bdab5;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_vmin" style="font-size:11px; font-weight:600; color:#ffb703;">-</span></div>
                </div>
              </div>
              <div style="margin-bottom: 4px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’µ ê±°ë˜ëŒ€ê¸ˆ N/B</div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_tmax" style="font-size:11px; font-weight:600; color:#4285f4;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_tmin" style="font-size:11px; font-weight:600; color:#9c27b0;">-</span></div>
                </div>
              </div>

              <!-- ì¶”ì´ ê·¸ë˜í”„ -->
              <div style="margin-bottom: 10px; position: relative; height: 70px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“Š ì¶”ì´ ê·¸ë˜í”„</div>
                <canvas id="${chartId}" style="position: absolute; top: 20px; left: 0; width: 100%; height: 50px !important;"></canvas>
              </div>
            </div>`;
          }).join('');

          // ë¯¸ë‹ˆ ì°¨íŠ¸ ë Œë”ë§ (ìµœëŒ€ 10ê°œ ì œí•œ)
          const maxCharts = 10;
          const drawList = buyOrders.slice(0, Math.min(buyOrders.length, maxCharts));
          const interval = window.currentActiveTimeframe || 'minute10';
          if (!window._buyCharts) window._buyCharts = {};
          drawList.forEach((o, idx) => {
            const id = `buyChart_${o.ts || idx}`;
            const el = document.getElementById(id);
            if (!el) return;
            const market = o.market || 'KRW-BTC';
            const ts = o.ts || '';
            let nbPath = o.nbverse_path || '';
            
            // nbverse_path ì •ê·œí™” (ì ˆëŒ€ ê²½ë¡œ â†’ ìƒëŒ€ ê²½ë¡œ)
            if (nbPath && nbPath.includes('data' + (nbPath.includes('\\') ? '\\' : '/'))) {
              const idx = nbPath.lastIndexOf('data');
              nbPath = nbPath.substring(idx).replace(/\\/g, '/');
            }
            
            const fmt10 = (v) => (v == null ? '-' : Number(v).toFixed(10));
            const setTxt = (sel, txt) => { const e = document.getElementById(sel); if (e) e.textContent = txt; };

            const applyCpAndPnl = () => {
              fetch(`/api/cards/chart?market=${encodeURIComponent(market)}&interval=${encodeURIComponent(interval)}&ts=${encodeURIComponent(ts)}&count=1`)
                .then(r => r.json()).then(j => {
                  const cp = j.current_price_now;
                  setTxt(`${id}_cpnow`, cp != null ? Math.round(cp).toLocaleString()+' KRW' : '-');
                  if (cp != null) {
                    const buyPrice = Number(o.price || 0);
                    const qty = Number(o.size || 0);
                    const feeRate = (window.UPBIT_FEE_RATE != null) ? Number(window.UPBIT_FEE_RATE) : 0.001;
                    const netProceedsPerUnit = (cp * (1 - feeRate));
                    const pnl = (netProceedsPerUnit - buyPrice) * qty;
                    const rate = buyPrice > 0 ? ((netProceedsPerUnit - buyPrice) / buyPrice) * 100 : 0;
                    const pnlEl = document.getElementById(`${id}_pnl`);
                    const rateEl = document.getElementById(`${id}_pnlRate`);
                    if (pnlEl) { pnlEl.textContent = Math.round(pnl).toLocaleString()+' KRW'; pnlEl.style.color = pnl >= 0 ? '#0ecb81' : '#f6465d'; }
                    if (rateEl) { rateEl.textContent = rate.toFixed(2)+'%'; rateEl.style.color = rate >= 0 ? '#0ecb81' : '#f6465d'; }
                  }
                }).catch(()=>{});
            };

            if (nbPath) {
              // ìŠ¤ëƒ…ìƒ· ì‚¬ìš©: ì°¨íŠ¸ëŠ” ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ, í˜„ì¬ê°€ëŠ” ë³„ë„ ì¡°íšŒ
              fetch(`/api/nbverse/load?path=${encodeURIComponent(nbPath)}`)
                .then(r => r.json())
                .then(j => {
                  if (!j || !j.ok) throw new Error('snapshot load failed');
                  drawBuyMiniChart(id, j.price || [], j.volume || []);
                  const nb = j.nb || {};
                  setTxt(`${id}_pmax`, fmt10(nb?.price?.max));
                  setTxt(`${id}_pmin`, fmt10(nb?.price?.min));
                  setTxt(`${id}_vmax`, fmt10(nb?.volume?.max));
                  setTxt(`${id}_vmin`, fmt10(nb?.volume?.min));
                  setTxt(`${id}_tmax`, fmt10(nb?.turnover?.max));
                  setTxt(`${id}_tmin`, fmt10(nb?.turnover?.min));
                  try {
                    const res = computeCardCodeFS({
                      priceMax: nb?.price?.max, priceMin: nb?.price?.min,
                      volumeMax: nb?.volume?.max, volumeMin: nb?.volume?.min,
                      amountMax: nb?.turnover?.max, amountMin: nb?.turnover?.min
                    });
                    const codeEl = document.getElementById(`${id}_ratingCode`);
                    const metaEl = document.getElementById(`${id}_ratingMeta`);
                    if (codeEl) codeEl.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span>`;
                    if (metaEl) metaEl.textContent = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''}`;
                    requestMlRating({ nb: nb, current_price: o.price, interval }, (ml) => {
                      if (codeEl) codeEl.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span> <span style="color:#ffd700;font-size:11px;">ML ${ml.grade}+${ml.enhancement}</span>`;
                      if (metaEl) metaEl.textContent = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''} | ML ${ml.grade} +${ml.enhancement}ê°•`;
                    });
                  } catch(_) {}
                })
                .catch(() => {
                  // í´ë°±: ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ ë¡œë“œ
                  fetch(`/api/cards/chart?market=${encodeURIComponent(market)}&interval=${encodeURIComponent(interval)}&ts=${encodeURIComponent(ts)}&count=180`)
                    .then(r => r.json())
                    .then(j => {
                      if (!j || !j.ok) return;
                      drawBuyMiniChart(id, j.price || [], j.volume || []);
                      setTxt(`${id}_pmax`, fmt10(j.nb?.price?.max));
                      setTxt(`${id}_pmin`, fmt10(j.nb?.price?.min));
                      setTxt(`${id}_vmax`, fmt10(j.nb?.volume?.max));
                      setTxt(`${id}_vmin`, fmt10(j.nb?.volume?.min));
                      setTxt(`${id}_tmax`, fmt10(j.nb?.turnover?.max));
                      setTxt(`${id}_tmin`, fmt10(j.nb?.turnover?.min));
                    })
                    .catch(()=>{});
                })
                .finally(() => {
                  applyCpAndPnl();
                });
            } else {
              // ê¸°ì¡´ ë°©ì‹: ì„œë²„ì—ì„œ ìº”ë“¤ + NB í†µê³„ ì¡°íšŒ
              fetch(`/api/cards/chart?market=${encodeURIComponent(market)}&interval=${encodeURIComponent(interval)}&ts=${encodeURIComponent(ts)}&count=180`)
                .then(r => r.json())
                .then(j => {
                  if (!j || !j.ok) return;
                  drawBuyMiniChart(id, j.price || [], j.volume || []);
                  setTxt(`${id}_pmax`, fmt10(j.nb?.price?.max));
                  setTxt(`${id}_pmin`, fmt10(j.nb?.price?.min));
                  setTxt(`${id}_vmax`, fmt10(j.nb?.volume?.max));
                  setTxt(`${id}_vmin`, fmt10(j.nb?.volume?.min));
                  setTxt(`${id}_tmax`, fmt10(j.nb?.turnover?.max));
                  setTxt(`${id}_tmin`, fmt10(j.nb?.turnover?.min));
                  try {
                    const res = computeCardCodeFS({
                      priceMax: j.nb?.price?.max, priceMin: j.nb?.price?.min,
                      volumeMax: j.nb?.volume?.max, volumeMin: j.nb?.volume?.min,
                      amountMax: j.nb?.turnover?.max, amountMin: j.nb?.turnover?.min
                    });
                    const codeEl = document.getElementById(`${id}_ratingCode`);
                    const metaEl = document.getElementById(`${id}_ratingMeta`);
                    if (codeEl) codeEl.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span>`;
                    if (metaEl) metaEl.textContent = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''}`;
                    requestMlRating({ nb: j.nb, current_price: o.price, interval }, (ml) => {
                      if (codeEl) codeEl.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span> <span style="color:#ffd700;font-size:11px;">ML ${ml.grade}+${ml.enhancement}</span>`;
                      if (metaEl) metaEl.textContent = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''} | ML ${ml.grade} +${ml.enhancement}ê°•`;
                    });
                  } catch(_) {}
                  const cp = j.current_price_now;
                  setTxt(`${id}_cpnow`, cp != null ? Math.round(cp).toLocaleString()+' KRW' : '-');
                  if (cp != null) {
                    const buyPrice = Number(o.price || 0);
                    const qty = Number(o.size || 0);
                    const feeRate = (window.UPBIT_FEE_RATE != null) ? Number(window.UPBIT_FEE_RATE) : 0.001;
                    const netProceedsPerUnit = (cp * (1 - feeRate));
                    const pnl = (netProceedsPerUnit - buyPrice) * qty;
                    const rate = buyPrice > 0 ? ((netProceedsPerUnit - buyPrice) / buyPrice) * 100 : 0;
                    const pnlEl = document.getElementById(`${id}_pnl`);
                    const rateEl = document.getElementById(`${id}_pnlRate`);
                    if (pnlEl) { pnlEl.textContent = Math.round(pnl).toLocaleString()+' KRW'; pnlEl.style.color = pnl >= 0 ? '#0ecb81' : '#f6465d'; }
                    if (rateEl) { rateEl.textContent = rate.toFixed(2)+'%'; rateEl.style.color = rate >= 0 ? '#0ecb81' : '#f6465d'; }
                  }
                })
                .catch(()=>{});
            }
          });

          // ë§¤ë„ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”© (ìµœëŒ€ 50ê°œ)
          buyOrders.slice(0, 50).forEach((o, idx) => {
            const id = `buyChart_${o.ts || idx}`;
            const btn = document.getElementById(`${id}_sellBtn`);
            if (!btn) return;
            btn.addEventListener('click', async () => {
              try {
                const card = document.getElementById(`buyCard_${o.ts || idx}`);
                const market = (card && card.getAttribute('data-market')) || o.market || 'KRW-BTC';
                const sizeStr = (card && card.getAttribute('data-size')) || '';
                const size = Number(sizeStr || o.size || 0);
                
                console.log('ğŸ” ë§¤ë„ ìš”ì²­ ë°ì´í„°:', { 
                  market, 
                  sizeStr, 
                  sizeFromAttr: card ? card.getAttribute('data-size') : 'no card',
                  sizeFromOrder: o.size,
                  parsedSize: size 
                });
                
                if (!size || size <= 0 || isNaN(size)) {
                  const errMsg = `ë§¤ë„ ì‹¤íŒ¨: ë§¤ë„ ìˆ˜ëŸ‰ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ (size=${sizeStr})`;
                  addTradeLog(errMsg, 'error');
                  console.error('âŒ', errMsg);
                  alert(errMsg);
                  return;
                }
                
                // ìµœì¢… í™•ì¸
                if (!confirm(`${market} ${size.toFixed(8)}ê°œë¥¼ ë§¤ë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                  return;
                }
                
                console.log('ğŸ”¥ ë§¤ë„ ì‹œì‘:', { market, size: size.toFixed(8) });
                btn.disabled = true; const oldTxt = btn.textContent; btn.textContent = 'ë§¤ë„ ì¤‘...';
                
                const resp = await fetch('/api/trade/sell', {
                  method: 'POST', headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ market, size })
                });
                
                console.log('ğŸ“¡ ë§¤ë„ ì‘ë‹µ ìƒíƒœ:', resp.status);
                const j = await resp.json();
                console.log('ğŸ“¦ ë§¤ë„ ì‘ë‹µ ë°ì´í„°:', j);
                
                if (j && j.ok) {
                  addTradeLog(`âœ… ë§¤ë„ ì™„ë£Œ: ${market} ${size.toFixed(8)}ê°œ`, 'success');
                  console.log('âœ… ë§¤ë„ ì™„ë£Œ:', { market, size });
                  // ëª©ë¡ ê°±ì‹ 
                  await loadTradeStats();
                } else {
                  const reason = j && j.error ? j.error : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                  const msg = j && j.message ? j.message : '';
                  addTradeLog(`âŒ ë§¤ë„ ì‹¤íŒ¨: ${reason} ${msg}`, 'error');
                  console.error('âŒ ë§¤ë„ ì‹¤íŒ¨:', reason, msg, j);
                  alert(`ë§¤ë„ ì‹¤íŒ¨: ${reason}\n${msg}`);
                }
                btn.disabled = false; btn.textContent = oldTxt;
              } catch (err) {
                console.error('âŒ ë§¤ë„ ì—ëŸ¬:', err);
                addTradeLog(`ë§¤ë„ ì‹¤íŒ¨: ${err.message}`, 'error');
                alert(`ë§¤ë„ ì‹¤íŒ¨: ${err.message}`);
                try { btn.disabled = false; btn.textContent = 'ì‹œì¥ê°€ ë§¤ë„'; } catch(_) {}
              }
            });
          });

          // ì‹¤ì‹œê°„ PnL ì—…ë°ì´íŠ¸ (15ì´ˆë§ˆë‹¤ ìƒìœ„ 10ê°œ)
          if (window._buyPnlTimer) clearInterval(window._buyPnlTimer);
          window._buyPnlTimer = setInterval(() => {
            const nodes = Array.from(document.querySelectorAll('[id^="buyCard_"]')).slice(0, maxCharts);
            nodes.forEach(node => {
              const ts = node.getAttribute('data-buy-ts');
              const market = node.getAttribute('data-market') || 'KRW-BTC';
              const id = `buyChart_${ts}`;
              fetch(`/api/cards/chart?market=${encodeURIComponent(market)}&interval=${encodeURIComponent(interval)}&ts=${encodeURIComponent(ts)}&count=1`)
                .then(r => r.json())
                .then(j => {
                  const cp = j.current_price_now;
                  const cpEl = document.getElementById(`${id}_cpnow`);
                  if (cpEl) cpEl.textContent = cp != null ? Math.round(cp).toLocaleString()+' KRW' : '-';
                  if (cp != null) {
                    const card = node; // wrapper
                    const buyPrice = Number(card.getAttribute('data-price') || 0) || 0;
                    const qty = Number(card.getAttribute('data-size') || 0) || 0;
                    const feeRate = (window.UPBIT_FEE_RATE != null) ? Number(window.UPBIT_FEE_RATE) : 0.001;
                    const netProceedsPerUnit = (cp * (1 - feeRate));
                    const pnl = (netProceedsPerUnit - buyPrice) * qty;
                    const rate = buyPrice > 0 ? ((netProceedsPerUnit - buyPrice) / buyPrice) * 100 : 0;
                    const pnlEl = document.getElementById(`${id}_pnl`);
                    const rateEl = document.getElementById(`${id}_pnlRate`);
                    if (pnlEl) { pnlEl.textContent = Math.round(pnl).toLocaleString()+' KRW'; pnlEl.style.color = pnl >= 0 ? '#0ecb81' : '#f6465d'; }
                    if (rateEl) { rateEl.textContent = rate.toFixed(2)+'%'; rateEl.style.color = rate >= 0 ? '#0ecb81' : '#f6465d'; }
                  }
                })
                .catch(() => {});
            });
          }, 15000);
        } else {
          buyListEl.innerHTML = '<div class="text-center text-muted py-2">ë§¤ìˆ˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        // ë§¤ë„ í†µê³„
        document.getElementById('sellCount').textContent = sellOrders.length;
        document.getElementById('sellTotalAmount').textContent = Math.round(sellTotal).toLocaleString() + ' KRW';
        document.getElementById('sellAvgPrice').textContent = Math.round(sellAvg).toLocaleString() + ' KRW';
        
        // ìˆ˜ìµ ê³„ì‚°
        const profit = sellTotal - buyTotal;
        const profitRate = buyTotal > 0 ? ((profit / buyTotal) * 100) : 0;
        const profitEl = document.getElementById('totalProfit');
        const profitRateEl = document.getElementById('profitRate');
        
        profitEl.textContent = Math.round(profit).toLocaleString() + ' KRW';
        profitEl.style.color = profit >= 0 ? '#0ecb81' : '#f6465d';
        profitRateEl.textContent = profitRate.toFixed(2) + '%';
        profitRateEl.style.color = profit >= 0 ? '#0ecb81' : '#f6465d';
        
        // ë§¤ë„ ë‚´ì—­ ì¹´ë“œ ëª©ë¡
        const sellListEl = document.getElementById('sellOrderList');
        if (sellOrders.length > 0) {
          const tfi = (window.currentActiveTimeframe || 'minute10');
          const tfMap = {minute1:'1m', minute3:'3m', minute5:'5m', minute10:'10m', minute15:'15m', minute30:'30m', minute60:'1h', day:'1D'};
          const tfLabel = tfMap[tfi] || tfi;
          sellListEl.innerHTML = sellOrders.slice(0, 20).map((o, idx) => {
            const price = Number(o.price || 0);
            const size = Number(o.size || 0);
            const totalKrw = (price * size).toFixed(0);
            const time = o.time ? new Date(o.time).toLocaleString('ko-KR') : (o.ts ? new Date(o.ts).toLocaleString('ko-KR') : '-');
            const paper = o.paper ? '[PAPER]' : '';
            const ins = o.insight || {};
            const zone = ins.zone || '-';
            const zoneColor = zone === 'BLUE' ? '#00d1ff' : zone === 'ORANGE' ? '#ffb703' : '#888';
            const zoneBg = zone === 'BLUE' ? 'rgba(0,209,255,0.3)' : zone === 'ORANGE' ? 'rgba(255,183,3,0.3)' : 'rgba(136,136,136,0.3)';
            const chartId = `sellChart_${o.ts || idx}`;
            return `<div id="sellCard_${o.ts || idx}" data-sell-ts="${o.ts || ''}" data-market="${o.market || 'KRW-BTC'}" data-price="${o.price || 0}" data-size="${o.size || 0}" style="background: linear-gradient(135deg, rgba(41,30,30,0.95), rgba(36,14,14,0.95)); border: 1px solid ${zoneBg}; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
              <!-- í—¤ë” -->
              <div style="border-bottom: 2px solid ${zoneBg}; padding-bottom: 8px; margin-bottom: 10px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                  <div style="display:flex; align-items:center; gap:8px;">
                    <strong style="color:#ffffff; font-size:14px;">ğŸ·ï¸ ë§¤ë„ #${idx + 1}</strong>
                    <span style="background:#f6465d; color:#0b1220; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700;">${tfLabel}</span>
                  </div>
                  <span style="background: ${zoneColor}; color: #0b1220; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 700;">${zone}</span>
                </div>
                <div style="font-size: 10px; color: #888; margin-top: 6px;">${time} ${paper}</div>
              </div>

              <!-- ì¹´ë“œ ë“±ê¸‰ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div style="background: rgba(255,215,0,0.08); border: 1px solid rgba(255,215,0,0.3); border-radius: 6px; padding: 8px;">
                  <div style="font-size:10px; color:#bbb;">ì¹´ë“œ ë“±ê¸‰</div>
                  <div id="${chartId}_cardGrade" style="font-size:14px; font-weight:700; color:#ffd700;">-</div>
                </div>
                <div style="background: rgba(230,238,252,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 8px;">
                  <div style="font-size:10px; color:#bbb;">ì ìˆ˜</div>
                  <div id="${chartId}_cardScore" style="font-size:14px; font-weight:700; color:#e6eefc;">-</div>
                </div>
              </div>

              <!-- ì¹´ë“œ ì½”ë“œ / ë¦¬ê·¸ -->
              <div style="display:flex; justify-content:space-between; align-items:center; margin: -4px 0 8px 0;">
                <div style="font-size:11px; color:#9aa8c2;">ì¹´ë“œ ì½”ë“œ</div>
                <div id="${chartId}_ratingCode" style="font-size:14px; font-weight:700;">-</div>
              </div>
              <div id="${chartId}_ratingMeta" style="font-size:11px; color:#9aa8c2; margin-top:-6px; margin-bottom:8px;">-</div>

              <!-- ë§¤ë„ ê°€ê²©/ìˆ˜ëŸ‰/ì´ì•¡ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                <div style="background: rgba(246,70,93,0.08); border: 1px solid rgba(246,70,93,0.3); border-radius: 6px; padding: 8px;">
                  <div style="font-size:10px; color:#bbb;">ë§¤ë„ ê°€ê²©</div>
                  <div style="font-size:14px; font-weight:700; color:#f6465d;">${price.toLocaleString()}</div>
                </div>
                <div style="background: rgba(230,238,252,0.05); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 8px;">
                  <div style="font-size:10px; color:#bbb;">ë§¤ë„ ìˆ˜ëŸ‰</div>
                  <div style="font-size:13px; font-weight:700; color:#e6eefc;">${size.toFixed(8)}</div>
                </div>
                <div style="background: rgba(66,133,244,0.08); border: 1px solid rgba(66,133,244,0.3); border-radius: 6px; padding: 8px;">
                  <div style="font-size:10px; color:#bbb;">ì´ ê¸ˆì•¡</div>
                  <div style="font-size:13px; font-weight:700; color:#4285f4;">${Number(totalKrw).toLocaleString()}</div>
                </div>
              </div>

              <!-- ì‹¤í˜„ ì†ìµ -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’° ì‹¤í˜„ ì†ìµ</div>
                  <div id="${chartId}_pnl" style="font-size:12px; font-weight:600; color:#0ecb81;">-</div>
                </div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“Š ì†ìµë¥ </div>
                  <div id="${chartId}_pnlRate" style="font-size:12px; font-weight:600; color:#0ecb81;">-</div>
                </div>
              </div>
              <!-- ğŸ¤– ML Trust / ğŸ—ºï¸ N/B Zone -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ¤– ML Trust</div>
                  <div id="${chartId}_mlTrust" style="font-size:12px; font-weight:600; color:#a78bfa;">-</div>
                </div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ—ºï¸ N/B Zone</div>
                  <div id="${chartId}_nbZone" style="font-size:12px; font-weight:600; color:#4285f4;">-</div>
                </div>
              </div>

              <!-- N/B ê°’ë“¤ -->
              <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_pmax" style="font-size:11px; font-weight:600; color:#0ecb81;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_pmin" style="font-size:11px; font-weight:600; color:#f6465d;">-</span></div>
                </div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“ˆ ê±°ë˜ëŸ‰ N/B</div>
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_vmax" style="font-size:11px; font-weight:600; color:#2bdab5;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_vmin" style="font-size:11px; font-weight:600; color:#ffb703;">-</span></div>
                </div>
                <div style="background: rgba(14,20,36,0.8); border-radius: 6px; padding: 8px; border: 1px solid rgba(255,255,255,0.1);">
                  <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ’µ ê±°ë˜ëŒ€ê¸ˆ N/B</div>
                  <div class="d-flex justify-content-between mb-2"><span class="text-muted" style="font-size:10px;">MAX</span><span id="${chartId}_tmax" style="font-size:11px; font-weight:600; color:#4285f4;">-</span></div>
                  <div class="d-flex justify-content-between"><span class="text-muted" style="font-size:10px;">MIN</span><span id="${chartId}_tmin" style="font-size:11px; font-weight:600; color:#9c27b0;">-</span></div>
                </div>
              </div>

              <!-- ì¶”ì´ ê·¸ë˜í”„ -->
              <div style="margin-bottom: 4px; position: relative; height: 60px;">
                <div style="font-size: 11px; font-weight: 600; color: #ffffff; margin-bottom: 6px;">ğŸ“Š ì¶”ì´ ê·¸ë˜í”„</div>
                <canvas id="${chartId}" style="position: absolute; top: 20px; left: 0; width: 100%; height: 40px !important;"></canvas>
              </div>
            </div>`;
          }).join('');

          // ë§¤ë„ ì¹´ë“œ ë¯¸ë‹ˆ ì°¨íŠ¸ ë° N/B ê°’ ì±„ìš°ê¸° (ìƒìœ„ 10ê°œ)
          const maxSellCharts = 10;
          sellOrders.slice(0, Math.min(sellOrders.length, maxSellCharts)).forEach((o, idx) => {
            const id = `sellChart_${o.ts || idx}`;
            const el = document.getElementById(id);
            if (!el) return;
            const market = o.market || 'KRW-BTC';
            const ts = o.ts || '';
            const fmt10 = (v) => (v == null ? '-' : Number(v).toFixed(10));
            const setTxt = (sel, txt) => { const e = document.getElementById(sel); if (e) e.textContent = txt; };
            
            // ì¹´ë“œ ë“±ê¸‰, ì ìˆ˜, ì‹¤í˜„ ì†ìµ, ML Trust ì„¤ì •
            const cardRating = o.card_rating || {};
            const mlTrust = o.ml_trust || {};
            const realizedPnl = o.realized_pnl || {};
            const nbZone = o.nb_zone || {};
            
            const cardGrade = cardRating.code ? `${cardRating.code} (${cardRating.league})` : '-';
            const cardScore = cardRating.avgDiff ? cardRating.avgDiff.toFixed(2) : '-';
            const cardEnhance = cardRating.enhancement ? `+${cardRating.enhancement}ê°•` : '-';
            const pnlAvg = realizedPnl.avg != null ? Math.round(realizedPnl.avg).toLocaleString() + ' KRW' : '-';
            const pnlRate = realizedPnl.avg != null && o.price ? ((realizedPnl.avg / o.price) * 100).toFixed(2) + '%' : '-';
            const mlTrustGrade = mlTrust.grade || '-';
            const nbZoneInfo = nbZone.zone ? `${nbZone.zone} (${nbZone.zone_conf?.toFixed(2) || '0.00'})` : '-';
            
            setTxt(`${id}_cardGrade`, cardGrade);
            setTxt(`${id}_cardScore`, cardScore);
            setTxt(`${id}_pnl`, pnlAvg);
            setTxt(`${id}_pnlRate`, pnlRate);
            setTxt(`${id}_mlTrust`, mlTrustGrade);
            setTxt(`${id}_nbZone`, nbZoneInfo);
            
            fetch(`/api/cards/chart?market=${encodeURIComponent(market)}&interval=${encodeURIComponent(tfi)}&ts=${encodeURIComponent(ts)}&count=180`)
              .then(r => r.json())
              .then(j => {
                if (!j || !j.ok) return;
                drawBuyMiniChart(id, j.price || [], j.volume || []);
                setTxt(`${id}_pmax`, fmt10(j.nb?.price?.max));
                setTxt(`${id}_pmin`, fmt10(j.nb?.price?.min));
                setTxt(`${id}_vmax`, fmt10(j.nb?.volume?.max));
                setTxt(`${id}_vmin`, fmt10(j.nb?.volume?.min));
                setTxt(`${id}_tmax`, fmt10(j.nb?.turnover?.max));
                setTxt(`${id}_tmin`, fmt10(j.nb?.turnover?.min));
                try {
                  const res = computeCardCodeFS({
                    priceMax: j.nb?.price?.max, priceMin: j.nb?.price?.min,
                    volumeMax: j.nb?.volume?.max, volumeMin: j.nb?.volume?.min,
                    amountMax: j.nb?.turnover?.max, amountMin: j.nb?.turnover?.min
                  });
                  const codeEl = document.getElementById(`${id}_ratingCode`);
                  const metaEl = document.getElementById(`${id}_ratingMeta`);
                  if (codeEl) codeEl.innerHTML = `<span style="color:${res.color};">${res.code}</span> <span style="color:#ffd700;font-size:12px;">+${res.enhancement}ê°•</span>`;
                  if (metaEl) metaEl.textContent = `${res.league} ${res.group}${res.super ? ' â€¢ SUPER' : ''}`;
                } catch(_) {}
              })
              .catch(()=>{});
          });
        } else {
          sellListEl.innerHTML = '<div class="text-center text-muted py-2">ë§¤ë„ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
        }
        
        console.log('âœ… Trade stats loaded:', { buyCount: buyOrders.length, sellCount: sellOrders.length });
      } catch (err) {
        console.error('loadTradeStats error:', err);
      }
    }
    
    // ê±°ë˜ í†µê³„ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ë° ì´ˆê¸° ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
      const refreshBtn = document.getElementById('tradeStatsRefresh');
      if (refreshBtn) refreshBtn.addEventListener('click', loadTradeStats);

      const logRefreshBtn = document.getElementById('tradeLogRefresh');
      if (logRefreshBtn) logRefreshBtn.addEventListener('click', loadTradeStats);
      
      // ë§¤ìˆ˜/ë§¤ë„ ì¹´ë“œ JSON ë‚´ë³´ë‚´ê¸°
      const exportBuyBtn = document.getElementById('exportBuyCards');
      if (exportBuyBtn) {
        exportBuyBtn.addEventListener('click', () => {
          try {
            const cached = JSON.parse(localStorage.getItem('cachedOrders') || '[]');
            const buyOrders = cached.filter(o => o.side === 'bid' || o.side === 'BUY');
            const filename = `buy_cards_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            const blob = new Blob([JSON.stringify(buyOrders, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            addTradeLog(`ë§¤ìˆ˜ ì¹´ë“œ ${buyOrders.length}ê°œë¥¼ ${filename}ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
          } catch (err) {
            addTradeLog(`ë§¤ìˆ˜ ì¹´ë“œ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
          }
        });
      }
      
      const exportSellBtn = document.getElementById('exportSellCards');
      if (exportSellBtn) {
        exportSellBtn.addEventListener('click', () => {
          try {
            const cached = JSON.parse(localStorage.getItem('cachedOrders') || '[]');
            const sellOrders = cached.filter(o => o.side === 'ask' || o.side === 'SELL');
            const filename = `sell_cards_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            const blob = new Blob([JSON.stringify(sellOrders, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            addTradeLog(`ë§¤ë„ ì¹´ë“œ ${sellOrders.length}ê°œë¥¼ ${filename}ë¡œ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.`, 'success');
          } catch (err) {
            addTradeLog(`ë§¤ë„ ì¹´ë“œ ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨: ${err.message}`, 'error');
          }
        });
      }
      
      // ì´ˆê¸° ë¡œë“œ
      loadTradeStats();
      
      // 30ì´ˆë§ˆë‹¤ ìë™ ê°±ì‹ 
      setInterval(loadTradeStats, 30000);
    });
    
    // í•˜ë‹¨ ë¶„ë´‰ ì¹´ë“œ ê¸°ëŠ¥ (ìë™ ìˆœíšŒ ìë™ ì‹œì‘)
    document.addEventListener('DOMContentLoaded', function() {
      if (window.bottomTimeframeInitDone) {
        console.log('â„¹ï¸ Bottom timeframe already initialized, skipping re-init');
        return;
      }
      window.bottomTimeframeInitDone = true;
      // ìë™ ìˆœíšŒ ê°„ê²©(ê¸°ë³¸ 30ì´ˆ) - ì „ì—­ì—ì„œ ì¡°ì • ê°€ëŠ¥
      if (!window.ROTATE_INTERVAL_MS) window.ROTATE_INTERVAL_MS = 30000;
      const timeframeCardsBottom = document.querySelectorAll('.timeframe-card-bottom');
      const timeframeSelect = document.getElementById('timeframe');
      const currentTimeframeBadgeBottom = document.getElementById('currentTimeframeBottom');
      const btnAutoRotateBottom = document.getElementById('btnAutoRotateBottom');
      
      let autoRotateIntervalBottom = window.autoRotateIntervalBottom || null;
      let currentTimeframeIndexBottom = 0; // 1më¶€í„° ì‹œì‘
      
      // í•˜ë‹¨ ë¶„ë´‰ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
      timeframeCardsBottom.forEach((card, index) => {
        card.addEventListener('click', function() {
          const timeframe = this.getAttribute('data-timeframe');

          // í™œì„± ì¹´ë“œ ë³€ê²½
          timeframeCardsBottom.forEach(c => c.classList.remove('active'));
          this.classList.add('active');

          // ìƒíƒœ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
          timeframeCardsBottom.forEach(c => {
            c.querySelector('.timeframe-status-bottom').textContent = 'ëŒ€ê¸°';
          });
          this.querySelector('.timeframe-status-bottom').textContent = 'í™œì„±';

          // UI ë°°ì§€ ì—…ë°ì´íŠ¸
          if (currentTimeframeBadgeBottom) {
            currentTimeframeBadgeBottom.textContent = this.querySelector('.timeframe-name-bottom').textContent;
          }

          // í˜„ì¬ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
          currentTimeframeIndexBottom = index;

          // ë¶„ë´‰ ì „í™˜ (ê°€ëŠ¥í•˜ë©´ ì „ì—­ í•¨ìˆ˜ ì‚¬ìš©í•´ ìƒë‹¨ í‘œì‹œê¹Œì§€ ë™ê¸°í™”)
          if (typeof window.switchToTimeframe === 'function') {
            window.switchToTimeframe(timeframe);
          } else {
            timeframeSelect.value = timeframe;
            timeframeSelect.dispatchEvent(new Event('change'));
          }

          console.log(`í•˜ë‹¨ ë¶„ë´‰ ë³€ê²½: ${timeframe}`);
        
          // í˜„ì¬ í™œì„± ë¶„ë´‰ ì—…ë°ì´íŠ¸
          currentActiveTimeframe = timeframe;
          window.currentActiveTimeframe = timeframe;
        
          // í˜„ì¬ ì¹´ë“œ ì—…ë°ì´íŠ¸
          loadCurrentCardDebounced();
        });
      });
      
      // í•˜ë‹¨ ìë™ ìˆœíšŒ í† ê¸€
      if (btnAutoRotateBottom) {
        btnAutoRotateBottom.addEventListener('click', function() {
          if (autoRotateIntervalBottom) {
            // ìë™ ìˆœíšŒ ì¤‘ì§€
            clearInterval(autoRotateIntervalBottom);
            autoRotateIntervalBottom = null;
            window.autoRotateIntervalBottom = null;
            this.textContent = 'ìë™ ìˆœíšŒ';
            this.classList.remove('btn-danger');
            this.classList.add('btn-outline-info');
          } else {
            // ìë™ ìˆœíšŒ ì‹œì‘
            autoRotateIntervalBottom = setInterval(() => {
              // í˜„ì¬ ì¹´ë“œ ë¡œë”© ì¤‘ì´ë©´ ìŠ¤í‚µ
              if (window.isLoadingCurrentCard || currentCardTimeout) return;
              currentTimeframeIndexBottom = (currentTimeframeIndexBottom + 1) % timeframeCardsBottom.length;
              timeframeCardsBottom[currentTimeframeIndexBottom].click();
            }, window.ROTATE_INTERVAL_MS);
            window.autoRotateIntervalBottom = autoRotateIntervalBottom;
            
            this.textContent = 'ìˆœíšŒ ì¤‘ì§€';
            this.classList.remove('btn-outline-info');
            this.classList.add('btn-danger');
          }
        });
      }
      
      // ì´ˆê¸° ì„¤ì • ë° ìë™ ìˆœíšŒ ìë™ ì‹œì‘
      if (timeframeCardsBottom.length > 0) {
        // 1më¶€í„° ì‹œì‘
        timeframeCardsBottom[0].click();
        
        // 2ì´ˆ í›„ ìë™ ìˆœíšŒ ì‹œì‘
        setTimeout(() => {
          if (btnAutoRotateBottom && !autoRotateIntervalBottom) {
            autoRotateIntervalBottom = setInterval(() => {
              // í˜„ì¬ ì¹´ë“œ ë¡œë”© ì¤‘ì´ë©´ ìŠ¤í‚µ
              if (window.isLoadingCurrentCard || currentCardTimeout) return;
              currentTimeframeIndexBottom = (currentTimeframeIndexBottom + 1) % timeframeCardsBottom.length;
              timeframeCardsBottom[currentTimeframeIndexBottom].click();
            }, window.ROTATE_INTERVAL_MS);
            window.autoRotateIntervalBottom = autoRotateIntervalBottom;
            
            if (btnAutoRotateBottom) {
              btnAutoRotateBottom.textContent = 'ìˆœíšŒ ì¤‘ì§€';
              btnAutoRotateBottom.classList.remove('btn-outline-info');
              btnAutoRotateBottom.classList.add('btn-danger');
            }
          }
        }, 2000);
      }
     });

    // Win% íˆìŠ¤í† ë¦¬ ë¡œë“œ í•¨ìˆ˜
    function loadWinHistory() {
      try {
        if (!Array.isArray(window.winClientHistory)) restoreWinHistoryFromLocal();
        const historyFile = 'data/win_history_10m.json'; // ê¸°ë³¸ê°’
        fetch('/api/nbverse/zone?interval=minute10')
          .then(r => r.json())
          .then(j => {
            if (!j || !j.ok) return;
            const winList = document.getElementById('winList');
            const winMajor = document.getElementById('winMajor');
            const winFillBar = document.getElementById('winFillBar');
            const winLocalCount = document.getElementById('winLocalCount');
            const winServerCount = document.getElementById('winServerCount');
            
            if (!winList) return;
            
            const zone = j.current_zone || '-';
            const count = j.zone_count || 0;
            const history = j.zone_history || [];

            if (winLocalCount) winLocalCount.textContent = (window.winClientHistory || []).length;
            if (winServerCount) winServerCount.textContent = history.length;
            
            // í—¤ë” ì—…ë°ì´íŠ¸
            if (winMajor) {
              winMajor.textContent = zone;
              winMajor.className = `badge zone-display-badge ${zone === 'BLUE' ? 'bg-info' : zone === 'ORANGE' ? 'bg-warning' : 'bg-secondary'}`;
            }
            
            // íˆìŠ¤í† ë¦¬ í•­ëª© ë Œë”ë§ (ìµœëŒ€ 25ê°œ)
            const items = history.slice(0, 25);
            const now = new Date();

            // ì„¸ì…˜ ë‚´ ëˆ„ì ëœ í˜„ì¬ ì¹´ë“œ ìŠ¤ëƒ…ìƒ·ì„ ìƒë‹¨ì— ëª¨ë‘ í‘œì‹œ
            const tfMap = {minute1:'1m', minute3:'3m', minute5:'5m', minute10:'10m', minute15:'15m', minute30:'30m', minute60:'1h', day:'1D'};
            let clientRowsHtml = '';
            try {
              const list = Array.isArray(window.winClientHistory) ? window.winClientHistory : [];
              clientRowsHtml = list.map((s, idx) => {
                const zoneColor = s.zone === 'BLUE' ? '#00d1ff' : s.zone === 'ORANGE' ? '#ffb703' : '#888888';
                const zoneBg = s.zone === 'BLUE' ? 'rgba(0,209,255,0.10)' : s.zone === 'ORANGE' ? 'rgba(255,183,3,0.10)' : 'rgba(255,255,255,0.04)';
                const zoneLabel = s.zone === 'BLUE' ? 'ğŸ”µ BLUE' : s.zone === 'ORANGE' ? 'ğŸŸ  ORANGE' : 'âšª NONE';
                const tfLabel = tfMap[s.tf] || s.tf || '10m';
                const enhLabel = s.enhancement ? ` +${s.enhancement}ê°•` : '';
                const sparkSlice = list.slice(idx, idx + 6);
                const step = sparkSlice.length ? 100 / sparkSlice.length : 100;
                const stops = sparkSlice.map((x, i2) => {
                  const start = Math.round(i2 * step);
                  const end = Math.round((i2 + 1) * step);
                  const c = x.zone === 'BLUE' ? '#00d1ff' : '#ffb703';
                  return `${c} ${start}% ${end}%`;
                }).join(', ');
                const sparkStyle = stops ? `background:linear-gradient(90deg, ${stops}); height:14px; border-radius:6px;` : 'background:rgba(255,255,255,0.08); height:14px; border-radius:6px;';
                return `
                  <div class="win-chip" style="border-left:3px solid ${zoneColor}; background:${zoneBg};">
                    <div style="display:flex; justify-content:space-between; width:100%;">
                      <div style="display:flex; align-items:center; gap:6px;">
                        <span style="font-weight:700; color:${s.color || '#e6eefc'};">ìŠ¤ëƒ…ìƒ· â€¢ ${s.code}</span>
                        <span style="color:#ffd700; font-size:11px; font-weight:700;">${enhLabel}</span>
                        <span style="background:${zoneColor}; color:#0b1220; padding:1px 6px; border-radius:999px; font-size:10px; font-weight:700;">${tfLabel}</span>
                      </div>
                      <div style="color:${zoneColor}; font-weight:700;">${zoneLabel}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; width:100%; font-size:11px; color:#9aa8c2;">
                      <span>${(new Date(s.ts)).toLocaleTimeString('ko-KR')}</span>
                      <span>${s.league} ${s.group}${s.super ? ' â€¢ SUPER' : ''}</span>
                    </div>
                    <div style="margin-top:6px;">
                      <canvas id="winSpark_${idx}" data-spark-idx="${idx}" width="120" height="36" style="width:100%; height:36px;"></canvas>
                    </div>
                  </div>`;
              }).join('');
            } catch(_) {}

            const listHtml = items.map((item, idx) => {
              const isBlue = item === 'BLUE' || item === 'B';
              const color = isBlue ? '#00d1ff' : '#ffb703';
              const label = isBlue ? 'ğŸ”µ' : 'ğŸŸ ';
              const sign = isBlue ? '+' : '-';
              
              // ìƒëŒ€ ì‹œê°„ ê³„ì‚° (idxë²ˆì§¸ëŠ” í˜„ì¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ idx * 10ë¶„ ì „)
              const timeMs = now.getTime() - (idx * 10 * 60 * 1000);
              const timeObj = new Date(timeMs);
              const elapsedSec = Math.floor((now.getTime() - timeMs) / 1000);
              
              // ìƒëŒ€ ì‹œê°„ í‘œì‹œ (ëª‡ì´ˆì „, ëª‡ë¶„ì „, ëª‡ì‹œê°„ì „)
              let relativeTime = '';
              if (elapsedSec < 60) {
                relativeTime = elapsedSec + 'ì´ˆì „';
              } else if (elapsedSec < 3600) {
                const minutes = Math.floor(elapsedSec / 60);
                relativeTime = minutes + 'ë¶„ì „';
              } else {
                const hours = Math.floor(elapsedSec / 3600);
                relativeTime = hours + 'ì‹œê°„ì „';
              }
              
              // íˆìŠ¤í† ë¦¬(ê³¼ê±°)ëŠ” ì¡´ë§Œ í‘œì‹œ (ì¡´ ìƒ‰ìœ¼ë¡œ ë°°ê²½ í‹´íŠ¸, 10m ë°°ì§€ í‘œì‹œ)
              const bg = isBlue ? 'rgba(0,209,255,0.08)' : 'rgba(255,183,3,0.08)';
              return `<div style="display:flex; flex-direction:column; align-items:flex-start; gap:2px; padding:6px 8px; background:${bg}; border-radius:4px; font-size:10px; border-left:3px solid ${color};">
                <div style="display:flex; align-items:center; gap:4px; width:100%;">
                  <span style="font-weight:700; color:${color};">${label} ${item} ${sign}</span>
                  <span style="margin-left:auto; background:${color}; color:#0b1220; padding:1px 6px; border-radius:999px; font-size:10px; font-weight:700;">10m</span>
                </div>
                <div style="display:flex; justify-content:space-between; width:100%; color:#888; font-size:9px;">
                  <span>${relativeTime}</span>
                  <span></span>
                </div>
              </div>`;
            }).join('');

            const finalHtml = (clientRowsHtml || '') + listHtml;
            if (finalHtml) {
              winList.innerHTML = finalHtml;
              renderWinSnapshotSparks(window.winClientHistory || [], 'winSpark_');
            } else {
              winList.innerHTML = '<div style="text-align:center; color:#888; font-size:11px; padding:10px;">ë°ì´í„° ì—†ìŒ</div>';
            }
            
            // í”„ë¡œê·¸ë ˆìŠ¤ë°” ì—…ë°ì´íŠ¸
            if (winFillBar) {
              const fillRate = count > 0 ? Math.min(100, (count / 25) * 100) : 1;
              winFillBar.style.width = fillRate + '%';
            }

            updateWinTrendChart(window.winClientHistory || []);
            
            console.log('âœ… Win% íˆìŠ¤í† ë¦¬ ë¡œë“œ:', zone, count, 'ê°œ');
          })
          .catch(err => {
            console.warn('âš ï¸ Win% ë¡œë“œ ì‹¤íŒ¨:', err);
            try {
              const winList = document.getElementById('winList');
              if (!winList) return;
              const tfMap = {minute1:'1m', minute3:'3m', minute5:'5m', minute10:'10m', minute15:'15m', minute30:'30m', minute60:'1h', day:'1D'};
              const list = Array.isArray(window.winClientHistory) ? window.winClientHistory : [];
              const fallback = list.map((s, idx) => {
                const zoneColor = s.zone === 'BLUE' ? '#00d1ff' : s.zone === 'ORANGE' ? '#ffb703' : '#888888';
                const zoneBg = s.zone === 'BLUE' ? 'rgba(0,209,255,0.10)' : s.zone === 'ORANGE' ? 'rgba(255,183,3,0.10)' : 'rgba(255,255,255,0.04)';
                const zoneLabel = s.zone === 'BLUE' ? 'ğŸ”µ BLUE' : s.zone === 'ORANGE' ? 'ğŸŸ  ORANGE' : 'âšª NONE';
                const tfLabel = tfMap[s.tf] || s.tf || '10m';
                const sparkSlice = list.slice(idx, idx + 6);
                const step = sparkSlice.length ? 100 / sparkSlice.length : 100;
                const stops = sparkSlice.map((x, i2) => {
                  const start = Math.round(i2 * step);
                  const end = Math.round((i2 + 1) * step);
                  const c = x.zone === 'BLUE' ? '#00d1ff' : '#ffb703';
                  return `${c} ${start}% ${end}%`;
                }).join(', ');
                const sparkStyle = stops ? `background:linear-gradient(90deg, ${stops}); height:14px; border-radius:6px;` : 'background:rgba(255,255,255,0.08); height:14px; border-radius:6px;';
                return `
                  <div class="win-chip" style="border-left:3px solid ${zoneColor}; background:${zoneBg};">
                    <div style="display:flex; justify-content:space-between; width:100%;">
                      <div style="display:flex; align-items:center; gap:6px;">
                        <span style="font-weight:700; color:${s.color || '#e6eefc'};">ìŠ¤ëƒ…ìƒ· â€¢ ${s.code}</span>
                        <span style="background:${zoneColor}; color:#0b1220; padding:1px 6px; border-radius:999px; font-size:10px; font-weight:700;">${tfLabel}</span>
                      </div>
                      <div style="color:${zoneColor}; font-weight:700;">${zoneLabel}</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; width:100%; font-size:11px; color:#9aa8c2;">
                      <span>${(new Date(s.ts)).toLocaleTimeString('ko-KR')}</span>
                      <span>${s.league} ${s.group}${s.super ? ' â€¢ SUPER' : ''}</span>
                    </div>
                    <div style="margin-top:6px;">
                      <canvas id="winSparkFb_${idx}" data-spark-idx="${idx}" width="120" height="24" style="width:100%; height:24px;"></canvas>
                    </div>
                  </div>`;
              }).join('');
              winList.innerHTML = fallback || '<div style="text-align:center; color:#888; font-size:11px; padding:10px;">ë°ì´í„° ì—†ìŒ</div>';
              renderWinSnapshotSparks(window.winClientHistory || [], 'winSparkFb_');
            } catch (_) {}
            updateWinTrendChart(window.winClientHistory || []);
          });
      } catch (e) {
        console.warn('âš ï¸ Win% ë¡œë“œ ì—ëŸ¬:', e);
      }
    }

    function updateWinTrendChart(entries) {
      try {
        const list = Array.isArray(entries) ? entries.slice(0, 40) : [];
        const ordered = list.slice().reverse(); // ì˜¤ë˜ëœ â†’ ìµœì‹ 
        const labels = [];
        const data = [];
        let blue = 0;
        let total = 0;
        ordered.forEach(item => {
          total += 1;
          if (item.zone === 'BLUE') blue += 1;
          const rate = total > 0 ? (blue / total) * 100 : 0;
          const ts = item.ts ? new Date(item.ts) : new Date();
          labels.push(ts.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }));
          data.push(Number(rate.toFixed(2)));
        });

        const labelEl = document.getElementById('winTrendLabel');
        if (labelEl) {
          labelEl.textContent = data.length ? `${data[data.length-1].toFixed(1)}%` : '-';
        }

        const ctx = document.getElementById('winTrendChart');
        if (!ctx) return;
        if (winTrendChart) {
          winTrendChart.data.labels = labels;
          winTrendChart.data.datasets[0].data = data;
          winTrendChart.update();
          return;
        }
        winTrendChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'BLUE ë¹„ìœ¨',
              data,
              borderColor: '#00d1ff',
              backgroundColor: 'rgba(0,209,255,0.15)',
              tension: 0.25,
              fill: true,
              pointRadius: 0,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: { color: '#d9e2f3', font: { size: 10 } },
                grid: { color: 'rgba(255,255,255,0.08)' }
              },
              x: {
                ticks: { color: '#9aa8c2', font: { size: 9 }, maxRotation: 0, autoSkip: true, maxTicksLimit: 6 },
                grid: { display: false }
              }
            },
            plugins: { legend: { display: false }, tooltip: { enabled: true } }
          }
        });
      } catch (e) {
        console.warn('âš ï¸ Win% trend chart error:', e?.message);
      }
    }

    function renderWinSnapshotSparks(list, prefix = 'winSpark_') {
      try {
        const arr = Array.isArray(list) ? list : [];
        arr.forEach((entry, idx) => {
          const cid = `${prefix}${idx}`;
          const cv = document.getElementById(cid);
          if (!cv) return;
          const slice = arr.slice(idx, idx + 6);
          if (!slice.length) return;
          const ctx = cv.getContext('2d');
          const w = cv.width || 120;
          const h = cv.height || 36;
          ctx.clearRect(0, 0, w, h);
          ctx.lineWidth = 2;
          ctx.strokeStyle = '#00d1ff';
          ctx.beginPath();
          slice.forEach((s, i) => {
            const val = s.zone === 'BLUE' ? 1 : s.zone === 'ORANGE' ? 0 : 0.5;
            const x = (w * i) / Math.max(1, slice.length - 1);
            const y = h - val * h;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
        });
      } catch (e) {
        console.warn('spark render err', e?.message);
      }
    }
    
    // DOMContentLoadedì—ì„œ Win% íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ë° ì£¼ê¸°ì  ê°±ì‹ 
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        restoreWinHistoryFromLocal();
        loadWinHistory();
        // 10ì´ˆë§ˆë‹¤ Win% íˆìŠ¤í† ë¦¬ ê°±ì‹ 
        setInterval(loadWinHistory, 10000);
      });
    } else {
      // ì´ë¯¸ ë¡œë“œëœ ê²½ìš° ì¦‰ì‹œ ì‹¤í–‰
      setTimeout(() => {
        restoreWinHistoryFromLocal();
        loadWinHistory();
        // 10ì´ˆë§ˆë‹¤ Win% íˆìŠ¤í† ë¦¬ ê°±ì‹ 
        setInterval(loadWinHistory, 10000);
      }, 100);
    }

    // Trust Level Sliders ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    document.addEventListener('DOMContentLoaded', function() {
      const mlTrustSlider = document.getElementById('mlTrustSlider');
      const nbTrustSlider = document.getElementById('nbTrustSlider');
      const mlTrustBar = document.getElementById('mlTrustBar');
      const nbTrustBar = document.getElementById('nbTrustBar');
      const mlTrustValue = document.getElementById('mlTrustValue');
      const nbTrustValue = document.getElementById('nbTrustValue');
      const trustStatusText = document.getElementById('trustStatusText');
      const trustBalanceText = document.getElementById('trustBalanceText');

      function updateTrustDisplay() {
        const mlVal = Number(mlTrustSlider.value) || 50;
        const nbVal = Number(nbTrustSlider.value) || 50;

        // ë°” ì—…ë°ì´íŠ¸
        mlTrustBar.style.width = mlVal + '%';
        nbTrustBar.style.width = nbVal + '%';

        // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        mlTrustValue.textContent = mlVal + '%';
        nbTrustValue.textContent = nbVal + '%';

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        const diff = Math.abs(mlVal - nbVal);
        if (diff <= 10) {
          trustStatusText.textContent = 'Balanced';
          trustStatusText.className = 'badge bg-success';
        } else if (mlVal > nbVal) {
          trustStatusText.textContent = 'ML Dominant';
          trustStatusText.className = 'badge bg-primary';
        } else {
          trustStatusText.textContent = 'N/B Dominant';
          trustStatusText.className = 'badge bg-warning';
        }

        // ì”ì•¡ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        trustBalanceText.textContent = `ML: ${mlVal}% | N/B: ${nbVal}%`;

        // ì„œë²„ì— ì €ì¥ (ì„ íƒ)
        try {
          fetch('/api/trust/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ml_trust: mlVal, nb_trust: nbVal })
          }).catch(() => {});
        } catch (e) {}
      }

      if (mlTrustSlider) {
        mlTrustSlider.addEventListener('input', updateTrustDisplay);
      }
      if (nbTrustSlider) {
        nbTrustSlider.addEventListener('input', updateTrustDisplay);
      }

      // ì´ˆê¸°í™”
      updateTrustDisplay();
      
      // Win% íˆìŠ¤í† ë¦¬ ì´ˆê¸° ë¡œë“œ ë° ì£¼ê¸° ê°±ì‹ 
      restoreWinHistoryFromLocal();
      loadWinHistory();
      setInterval(loadWinHistory, 5000); // 5ì´ˆë§ˆë‹¤ ê°±ì‹ 
    });
   </script>
</body>
</html>